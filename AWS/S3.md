# Amazon S3

## ストレージタイプ

| ストレージタイプ               | 特徴                                                                 | 耐久性 (%) | 可用性 (%) |
|--------------------------------|----------------------------------------------------------------------|------------|------------|
| **S3 Standard**                | 高頻度アクセス用。一般的なデータストレージ。                        | 99.999999999 | 99.99      |
| **S3 Intelligent-Tiering**     | アクセスパターンに応じて自動でストレージクラスを変更。               | 99.999999999 | 99.9       |
| **S3 Standard-IA (Infrequent Access)** | 低頻度アクセス用、コスト効率を重視。                                 | 99.999999999 | 99.9       |
| **S3 One Zone-IA**             | 低頻度アクセス用。1つのAZにデータを保存、低コストでリスク有。        | 99.999999999 | 99.5       |
| **S3 Glacier**                 | 長期保存用アーカイブ。低コスト、復元に時間がかかる。                 | 99.999999999 | 99.9       |
| **S3 Glacier Deep Archive**    | 最も低コストなアーカイブストレージ。非常に低頻度でアクセスされるデータ向け。 | 99.999999999 | 99.9       |
| **S3 Outposts**                | AWS Outposts上のオンプレミスストレージ。地域のローカルで使用。       | 99.999999999 | 99.9       |


## AWS Storage Gateway
オンプレミスとAWS間でデータを連携するハイブリッドクラウドストレージサービス。

### iSCSI デバイス
iSCSI（Internet Small Computer System Interface）デバイス とは、IPネットワーク上でSCSIプロトコルを使用してストレージを接続するデバイス です。

- 特徴:
  - ネットワーク経由でブロックストレージを提供（ローカルディスクのように利用可能）
  - SAN（Storage Area Network）を構築するために使用
  - FC（Fibre Channel）より低コストで構築可能
- ユースケース:
  - サーバーがリモートストレージをローカルディスクのように使用
  - データベースや仮想化環境（VMware、Hyper-Vなど）のストレージとして活用
  - バックアップやディザスタリカバリ（DR）環境の構築

AWS では iSCSI ベースのストレージとして AWS Storage Gateway（ボリュームゲートウェイ）を提供。

### ボリュームゲートウェイ
オンプレミスのサーバーにiSCSI経由で接続し、バックアップやキャッシュをAWS上のストレージに保存するAWS Storage Gatewayの一機能。

| 種類         | データの主な保存場所 | 特徴                                 | ユースケース        |
|--------------|--------------------|--------------------------------------|---------------------|
| **キャッシュ型** | **AWS（S3）**        | よく使うデータのみローカルにキャッシュ | ストレージをクラウド化 |
| **保存型**     | **オンプレミス**       | データをローカルに保持しつつ、スナップショットをAWSへ | DR対策・バックアップ |

## S3のパフォーマンス向上

### プレフィックス
プレフィックスを利用して日付ベースでアップロードを分散することで少なくとも 3,500 リクエスト/秒、データの取得で 5,500 リクエスト /秒をサポートできるようにパフォーマンスを自動的に向上させることができます。

## オブジェクトロック

保存されているデータが削除されない方法には2種類ある。

- Amazon S3バケットにMFA Delete機能を適用して、ユーザーによるデータ削除時にMFA入力を必須化して、誤った削除を防止する。
- Amazon S3バケットの初期設定でデータが削除されないS3バケットをロックする。

オブジェクトロックは 保持モード（Retention Mode） と リーガルホールド（Legal Hold）　の2つのモードがあり、
保持モードはさらに コンプライアンスモード と ガバナンスモード がある。

| モード                   | 特徴                                                                                 | ユースケース                                |
|------------------------|----------------------------------------------------------------------------------------|---------------------------------------------|
| **ガバナンスモード**     | 管理者が許可すれば削除可能。IAM権限で制御。                                             | 誤削除防止、管理者の制御権限を残す場合        |
| **コンプライアンスモード** | 誰も削除不可。保持期間が過ぎるまで絶対保護。                                       | 法的要件や監査対応が必要なデータ              |
| **リーガルホールド**     | 保持期間に依存せず、無期限で削除を防止。管理者が手動で解除可能。                        | 訴訟中や法的義務によりデータ保護が必要な場合  |

## 暗号化方式

| 暗号化方式                         | 説明                                                                 |
|-----------------------------------|----------------------------------------------------------------------|
| **S3管理の暗号化（SSE-S3）**        | S3が自動的にオブジェクトを暗号化し、暗号化キーを管理。デフォルトの暗号化方式。 |
| **サーバーサイド暗号化（SSE-KMS）**  | AWS Key Management Service (KMS) を使って暗号化キーを管理。より高度な管理が可能。 |
| **サーバーサイド暗号化（SSE-C）**   | ユーザーが提供する暗号化キーを使ってオブジェクトを暗号化。AWSはキーを保持しない。 |
| **クライアントサイド暗号化**        | ユーザーがオブジェクトをアップロード前にローカルで暗号化し、S3に保存。 |

### 🔑 **S3の暗号化方式ごとのキー管理とローテーション**

| 暗号化方式                         | キーの管理者           | キーのローテーション方法                                                                                     |
|-----------------------------------|------------------------|-------------------------------------------------------------------------------------------------------------|
| **S3管理の暗号化（SSE-S3）**        | AWS                     | AWSが自動的にローテーション。ユーザーが直接操作することはできません。                                           |
| **サーバーサイド暗号化（SSE-KMS）**  | AWS KMS（ユーザーが管理） | ユーザーがKMSキー（CMK）を管理。自動ローテーション（年1回）を有効にでき、手動操作も可能。                         |
| **サーバーサイド暗号化（SSE-C）**   | ユーザー                 | ユーザーが完全に管理し、ローテーションも手動で実施。キーが変わるときは再アップロードが必要。                     |
| **クライアントサイド暗号化**        | ユーザー                 | ユーザーがローカルでキーを管理し、ローテーションも手動で実施。暗号化・復号もローカルで行う。                     |

---

#### 💡 **ポイント**
- **SSE-S3** はAWSがすべて自動管理しており、キー操作権限はユーザーにありません。  
- **SSE-KMS** ではユーザーがキー操作権限を持ち、自動ローテーションの設定や手動更新が可能です。  
- **SSE-C** と **クライアントサイド暗号化** はユーザーがフルコントロールし、ローテーション管理もすべて手動です。  



## クロスリージョンレプリケーション

S3クロスリージョンレプリケーションは、異なるAWSリージョン間でオブジェクトを自動的に複製する機能です。<br>
特定のS3バケットから別のリージョンのS3バケットへデータをコピーできます。

### 特徴
- 非同期レプリケーション
  - データは非同期的にレプリケーションされ、コピー元とコピー先が完全に同期されるわけではありません。
- バケット間でリージョンが異なる必要がある
  - 同一リージョンへのレプリケーションはサポートされていません。
- バージョニングが必須
  - レプリケーション元バケットとレプリケーション先バケット両方でバージョニングが有効である必要があります。
- フィルタリングが可能
  - プレフィックスやタグを使ってレプリケーション対象を絞り込むことができます。

### ユースケース
- 災害対策 (DR: Disaster Recovery)
  - 地理的に離れたリージョンにデータを複製して、障害時にデータを保護。
- パフォーマンス向上
  - 利用者の近いリージョンにデータを配置し、レイテンシーを削減。
- データ主権対応
  - データを特定のリージョンに保存する法規制への対応。

### クロスリージョンレプリケーション（CRR）の設定

1. S3バージョンイングを有効にする
2. ソースバケットの管理設定においてレプリケーションルールを追加し、宛先バケットを指定する
3. 宛先バケットのバケットポリシーを作成して、オブジェクトの所有権を宛先 S3 バケットの所有者に変更する。

## バージョン管理

S3オブジェクトの各バージョンを保存し、削除や更新を行った際にも過去のバージョンにアクセスできます。<br>
バージョン管理を有効にすると、同じオブジェクト名でも異なるバージョンのデータを保持できます。

## ライフサイクル管理

S3オブジェクトの保存期間に基づいて、オブジェクトの自動移行や削除を管理できます。
<br>例えば、一定期間経過したオブジェクトを Glacier に移行する、あるいは古いオブジェクトを削除するなどの設定が可能です。

S3のライフサイクル管理では、特定のバージョン（旧バージョン）だけを対象に自動的に処理を行うことが可能です。具体的には、バージョン管理を有効にしているバケットにおいて、ライフサイクルルールを作成する際に以下のように指定できます。

### 旧バージョンのみのライフサイクル管理
- 旧バージョンのみを削除する
  - ライフサイクルルールで、特定の期間を過ぎた削除されたオブジェクトのバージョン（Delete Marker）や以前のバージョンを削除することができます。

- 旧バージョンのアーカイブ
  - 古いバージョンのオブジェクトを安価なストレージ（例えば S3 Glacier）に自動的に移行するような設定も可能です。

#### 設定例
- 特定のバージョンを削除
    - 「バージョン管理」設定が有効なバケットで、旧バージョンに対してライフサイクルルールを適用して、指定した期間後に削除できます。
- 削除マーカーを自動削除
    - 削除マーカー（オブジェクトを削除したことを示す特殊なオブジェクト）を指定した期間が過ぎると自動で削除するように設定することも可能です。

## Amazon S3 バケットの分析機能

| 分析機能                        | 目的                                                    | 特徴                                                                 |
|---------------------------------|-------------------------------------------------------|----------------------------------------------------------------------|
| **S3 Analytics - Storage Class Analysis** (ストレージクラス分析) | オブジェクトの最適なストレージクラスを分析              | アクセスパターンに基づいて、データを適切なストレージクラスに移動するための提案を提供 |
| **S3 Inventory**                | バケット内のオブジェクトメタデータを定期的に取得        | 定期的にオブジェクト情報をCSV、ORC、Parquet形式でエクスポートし、データ状態を把握    |
| **S3 Access Analyzer**          | アクセス許可を分析し、適切な設定を確認                 | 不適切なアクセス権限の設定を検出し、セキュリティを強化                      |
| **S3 Select**                   | オブジェクトのデータにSQLクエリを実行                   | オブジェクト内の一部データをSQLクエリで抽出し、効率的に分析を実施               |
| **S3 Event Notifications**      | バケット内でのイベントをトリガーとして通知を送信        | オブジェクトの変更（作成、削除など）に基づき、SNS、SQS、Lambdaで通知              |
| **S3 Batch Operations**         | バケット内のオブジェクトに一括操作を実行               | 大量のオブジェクトに対して一括でタグ付け、ストレージクラスの変更、削除を実行        |
| **Amazon Athena**               | S3のデータに対してSQLクエリを実行                     | サーバーレスで直接データに対してSQLクエリを実行し、分析を行う                      |
| **Amazon QuickSight**           | S3データを視覚化し、ダッシュボードを作成               | インタラクティブなビジュアルダッシュボードを作成し、分析結果を視覚化                |

## イベント通知

Amazon S3 のイベント通知設定では、以下のAWSサービスを指定します。

- Amazon Simple Notification Service (Amazon SNS) のトピック
- Amazon Simple Queue Service (Amazon SQS) キュー
- AWS Lambda 関数
- Amazon EventBridge

## 静的WEBホスティング

S3バケットを用いて静的ウェブサイトを構築するには、まずS3バケットで静的ウェブホスティング機能を有効にする必要があります。次に、Index.htmlを設定することでウェブサイトの構成が完了します。さらに、このウェブサイトを一般のユーザーに表示させるためには、インターネットからのアクセスを許可する設定が求められます。そのためには、パブリックアクセスブロックを無効にし、バケットポリシーを設定してインターネットからのs3:GetObjectを許可する必要があります。

### 静的WEBホスティングのフロー

1. ブロックパブリックアクセスを無効化する
    - S3バケットの設定で、「ブロックパブリックアクセス」を無効にして、バケット内のオブジェクトがインターネットからアクセス可能になるようにします。
2. バケットポリシーでバケットの読取許可を設定する
    - バケットポリシーで、全てのユーザーに対して「`s3:GetObject`」アクション（読み取り権限）を許可します。これにより、Webサイトのコンテンツを公開できます。
3. index.htmlなどのインデックスドキュメントをバケット内に保存する
    - インデックスドキュメント（例：index.html）や必要なファイル（CSS、JavaScript、画像など）をバケットにアップロードします。
4. 静的WEBホスティングの設定画面でindex.htmlなどのインデックスドキュメントを設定し、有効化する
    - 「静的Webサイトホスティング」の設定を有効にし、インデックスドキュメントを指定します（例：index.html）。これにより、URLにアクセスしたときに表示されるページが設定されます。
