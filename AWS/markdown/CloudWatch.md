# Amazon CloudWatch

Amazon CloudWatchは、AWSのリソースやアプリケーション、サービスのパフォーマンス監視を行うためのサービスです。CloudWatchを使用すると、システムの健全性をリアルタイムで把握し、インフラの監視やアラートの設定、ログの管理、メトリクスの収集を行うことができます。

標準メトリクスでカバーされない項目、例えばメモリ使用量やディスクの空き容量などは、管理者が「カスタムメトリクス」として定義し、CloudWatchエージェントをインストールしたEC2インスタンスからAWS CLIコマンドやAPIを用いてCloudWatchへ送信することで監視できます。

| 種別            | メトリクス                                                              |
|-----------------|-------------------------------------------------------------------------|
| 標準メトリクス   | CPU使用率 (CPUUtilization)                                              |
|                 | ディスクの読み取り・書き込み量 (DiskReadBytes/DiskWriteBytes)            |
|                 | ネットワークトラフィック量 (NetworkIn/NetworkOut)                       |
| カスタムメトリクス | メモリ使用量                                                           |
|                 | ディスクの空き容量・使用状況                                             |
|                 | プロセス情報                                                             |

### 主な機能
- メトリクスの収集と監視:
  - EC2インスタンス、RDS、Lambda、S3など、AWSの各サービスのメトリクス（CPU使用率、メモリ使用量、ディスクI/O、ネットワークトラフィックなど）をリアルタイムで監視できます。
- ログ管理（CloudWatch Logs）:
  - サーバーやアプリケーションからのログデータを収集、保存、検索、分析できます。これにより、エラーログやイベントログを確認して、システムの問題を診断できます。
- アラームの設定:
  - 指定したメトリクスに基づいてアラームを設定し、特定の条件が発生した際に通知（SNS通知など）を受け取ることができます。例えば、CPU使用率が高すぎる場合にアラームを設定し、スケーリングのトリガーに利用できます。
  - 複数のメトリクスがしきい値を超えたときにアラームを通知したい場合は「複合アラーム」を作成することができる
- ダッシュボードの作成:
  - 複数のメトリクスをグラフとして可視化し、カスタムダッシュボードを作成して、システムやアプリケーションのパフォーマンスを一目で確認できるようにします。
- CloudWatch Insights:
  - ログデータをインタラクティブに検索、クエリ、分析できる機能です。特に、複雑なログデータの解析や、パフォーマンスのボトルネックを特定する際に役立ちます。
- CloudWatch Events:
  - 特定のシステムイベントや変更に対して自動的にアクションを実行するルールを設定できます。これにより、インフラの自動化やオーケストレーションが可能になります。
- CloudWatch Contributor Insights:
  - 特定のリソースに対するトラフィックやリクエストのパターンを分析し、どのリソースがパフォーマンスに影響を与えているかを視覚的に把握できます。

## Amazon CloudWatch エージェントとCloudWatch Logsの違い

| 項目                     | **Amazon CloudWatch エージェント**                                  | **CloudWatch Logs**                          |
|--------------------------|------------------------------------------------------------------|--------------------------------------------|
| **主な機能**              | メトリクスとログの収集・送信                                        | ログの保存、検索、モニタリング、分析       |
| **データ送信元**          | EC2インスタンス、オンプレミスサーバー、コンテナ                   | エージェントから送信されたログデータ       |
| **目的**                  | サーバーやアプリケーションのデータをCloudWatchに送信する           | 収集したログデータを保存し、分析する       |
| **利用シーン**            | サーバーやコンテナのパフォーマンス監視、ログの送信                | ログの長期保存、検索、アラート設定、分析   |
| **関連サービス**          | CloudWatchメトリクス、CloudWatch Logs、CloudWatch Alarms        | CloudWatchメトリクス、CloudWatch Insights  |
| **インストール場所**      | サーバーやインスタンス（Linux、Windows、コンテナなど）           | AWSクラウド内で保存されるログデータ        |
| **データの収集方法**      | メトリクス（CPU使用率、メモリ使用量など）、システムログやアプリケーションログを収集 | ログデータの保存、検索、視覚化、アラート設定 |

## CloudWatch Container Insights

Amazon ECS、EKS、Kubernetes、および Fargate などの コンテナ環境に特化したモニタリング機能

### 主な機能

|項目	|説明|
|----|-----|
|対象|	Amazon ECS / EKS / Kubernetes / AWS Fargate|
|収集内容|	CPU使用率、メモリ使用量、ディスクI/O、ネットワークI/O、コンテナ数など|
|可視化|	CloudWatchダッシュボードでグラフ表示、自動ダッシュボードも生成される|
|ログ統合|	CloudWatch Logsと連携し、ログとメトリクスを統合的に監視可能|
|粒度|	クラスター / ノード / サービス / タスク / コンテナ 単位での監視が可能|

### 使い方

1. CloudWatch Agent または AWS Distro for OpenTelemetry（ADOT） をインストール

2. 必要な IAM 権限を設定

3. CloudWatch による自動ダッシュボードが作成され、メトリクスが可視化される

## CloudWatch Logs Insights
CloudWatch Logsにおける単語のフィルタリングよりも高度な処理が可能で、例えば「特定のアプリケーションが一定期間に出力した"Error"を含むメッセージをカウントする」のようなクエリを実行することができます。

リアルタイム分析や短期間のデータ分析には優れていますが、長期間にわたる大量のデータの保存と詳細なSQLクエリには向いていない

## CloudWatchダッシュボードの共有

- 「ダッシュボードの共有」機能を使用することで、AWSアカウントを持たない相手と共有することが可能
- AWSアカウントやIAMユーザーを作成することなく、共有先のEメールアドレスを指定して、普段AWSを利用していないメンバーや社外の関係者とダッシュボード上の情報を簡単に共有することができる

## アクション

EC2インスタンスについては、メール通知だけではなく、インスタンスの再起動・停止・終了・復旧というアクションを実行可能。

復旧アクションは、ハードウェア異常が発生した際に自動的に新たなインスタンスで復旧することができ、障害によるサービス停止のリスクを抑えることができる

![imnage](https://ping-t-resouces.com/uploads/question_image/file/23106/k58701.jpg?t=1661918260)

## 複合アラーム

複数のメトリクスがしきい値を超えたときに通知を出したい場合は「複合アラーム」を作成する。

例えば「CPU使用率が80%を超えたとき」に通知するアラームと、「受信ネットワークトラフィック量が60MB/分を超えたとき」に通知するアラームが両方アラーム状態になった場合に、複合アラームを通知するという設定ができる。
