# VPC

##  VPC エンドポイント

VPC内からインターネットを介さずに、AWSのサービスにプライベート接続を提供するための機能です。これにより、セキュアで高性能な通信が可能となり、インターネットのトラフィックを経由せずに、VPC内のリソースからAWSサービスにアクセスできます。

主な特徴
- プライベート接続：VPC内から直接、インターネットを介さずにAWSサービスに接続。
- セキュリティ：インターネットを経由しないため、セキュリティリスクが低減されます。
- 高パフォーマンス：プライベート接続により、遅延や帯域制限を抑え、安定したパフォーマンスを提供。

| タイプ                    | 概要                                                      | 使用例                                  | プロトコル                    |
|-------------------------|---------------------------------------------------------|-------------------------------------|----------------------------|
| **インターフェイスエンドポイント（Interface Endpoint）** | ENI（Elastic Network Interface）を使って、サービスにプライベート接続 | AWSサービス（S3、DynamoDB、SNSなど）やプライベートサービスへの接続 | TCP、UDP（HTTPSなど）          |
| **ゲートウェイエンドポイント（Gateway Endpoint）**     | VPCのルートテーブルを更新し、インターネット経由ではなくプライベートネットワーク経由でサービスにアクセス | S3やDynamoDBへのプライベートアクセス       | HTTP、HTTPS                   |


| エンドポイントタイプ             | 設定可能なリソース                                                                 |
|---------------------------|------------------------------------------------------------------------|
| **インターフェイスエンドポイント** | AWSの多くのサービス（S3、DynamoDB、SNS、SQS、Lambda、CloudWatchなど）やカスタムサービス |
| **ゲートウェイエンドポイント**    | **Amazon S3**と**Amazon DynamoDB**                                      |

[インターフェイスエンドポイントに対応しているサービス一覧](https://docs.aws.amazon.com/vpc/latest/privatelink/aws-services-privatelink-support.html)

## サブネット

### AWS VPCのサブネットごとのIPアドレスの数

| サブネットのサイズ (CIDR) | 利用可能なIPアドレス数 |
|-------------------------|-----------------------|
| /28                     | 16                    |
| /27                     | 32                    |
| /26                     | 64                    |
| /25                     | 128                   |
| /24                     | 256                   |
| /23                     | 512                   |
| /22                     | 1024                  |
| /21                     | 2048                  |
| /20                     | 4096                  |
| /19                     | 8192                  |
| /18                     | 16384                 |
| /17                     | 32768                 |
| /16                     | 65536                 |


## VPCにおけるDNSの使用

VPC 内で起動したインスタンスがパブリック IP アドレスに対応するパブリック DNS ホスト名を受け取るための設定が必要

| パラメータ                | 説明                                                                                                                       |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------|
| **enableDnsHostnames**   | - パブリック IP アドレスを持つインスタンスが、対応するパブリック DNS ホスト名を取得するかどうか示す。                       |
|                          | - この属性が `true` で `enableDnsSupport` 属性も `true` 場合、VPC 内のインスタンスは DNS ホスト名を取得する。                |
| **enableDnsSupport**     | - DNS 解決がサポートされているかどうかを示す。                                                                                |
|                          | - この属性が `false` の場合、パブリック DNS ホスト名を IP アドレスに解決する Amazon Route 53 Resolver サーバーが機能しない。 |
|                          | - この属性が `true` の場合、Amazon が提供する DNS サーバー（IP アドレス `169.254.169.253`）へのクエリ、                       |
|                          |   またはリザーブド IP アドレス（VPC IPv4 ネットワークの範囲に 2 をプラスしたアドレス）へのクエリは成功する。                  |

## VPCフローログと拡張VPCルーティングの違い
- VPCフローログ
  - VPCに出入りするログ。それを監視する。

- 拡張VPCルーティング
  - トラフィックがVPCを通るように強制する。
それによってVPCフローログで監視ができるようになる。

| 機能                 | VPCフローログ                             | 拡張VPCルーティング（Enhanced VPC Routing） |
|----------------------|------------------------------------------|-------------------------------------------|
| **目的**             | ネットワークトラフィックの監視と記録     | ネットワークトラフィックの経路制御       |
| **主な機能**         | トラフィックの詳細な情報（送信元IP、宛先IPなど）を記録し、監視を行う | VPC内外のトラフィック経路を制御して、外部通信をVPC経由でルーティング |
| **用途**             | セキュリティ監視、トラブルシューティング、パフォーマンス分析 | RedshiftなどのネットワークトラフィックをVPC経由で制御 |
| **出力先**           | CloudWatch Logs、S3バケット             | VPCのルーティングテーブルを通じて        |
| **トラフィック制御** | なし（あくまで監視・記録）               | あり（ネットワーク経路の制御）            |

## VPCピアリング

異なるVPC（Virtual Private Cloud）同士をプライベートネットワークで接続する機能です。これにより、VPC間でプライベートIPアドレスを使った通信が可能になります。

https://docs.aws.amazon.com/ja_jp/vpc/latest/peering/vpc-peering-basics.html#vpc-peering-limitations

### 特徴
- 同じAWSアカウント内または異なるAWSアカウント間でVPCを接続可能。
- AWSリージョン内だけでなく、異なるリージョン間（リージョン間VPCピアリング）でも接続できる。
- シンプルなネットワーク設計（VPNやインターネットゲートウェイを必要としない）。

### 主なユースケース
- 複数のVPCを接続し、システムを分割運用（例：アプリケーションVPCとデータベースVPCを接続）。
- 異なるAWSアカウントのVPC間で安全に通信（企業間のシステム連携）。

### 注意点
- トランジティブルーティング（中継通信）は不可（VPC A ⇄ VPC B、VPC B ⇄ VPC Cの場合、A ⇄ Cは直接通信不可）。
- CIDRブロックが重複していると接続できない。
- ルートテーブルで明示的にルートを設定する必要がある。
- 別リージョンのVPCのセキュリティグループをインバウンドルール内で指定することはできない

## ネットワークACL

- ルール番号の小さい順にルールが適用
- ルール間で矛盾がある場合は、小さいルール番号のルールが優先

## Elastic Network Interface（ENI）

### ENIの主な機能
1. プライマリおよびセカンダリIPアドレスの割り当て
    - 1つのENIに複数のプライベートIPアドレスを設定可能
    - 必要に応じてセカンダリIPを追加

2. 複数のENIをEC2インスタンスにアタッチ可能
    - 1つのインスタンスに複数のENIを持たせ、異なるサブネットやセグメントに接続可能
3. 異なるインスタンス間でENIを移動可能
    - 別のインスタンスにアタッチすることで、IPアドレスや設定をそのまま引き継げる
4. セキュリティグループやネットワークACLの適用
    - ENIごとに異なるセキュリティグループを設定でき、細かいアクセス制御が可能

### ネットワークインターフェースをEC2インスタンスに接続する方法

- 稼働中のアタッチ（ホットアタッチ）
- 停止中のアタッチ（ウォームアタッチ）
- インスタンス起動中のアタッチ（コールドアタッチ）

## PrivateLink

AWS PrivateLink は、VPC 内から他の AWS サービスや VPC サービスに対して、インターネットを経由せずにプライベート接続できる仕組み。

利用料金が発生するため、無料で利用可能なゲートウェイ型VPCエンドポイントの方がコスト削減になる。

プライベートサブネット内のAWSリソースからVPC外のAWSサービスへ、プライベートネットワーク経由でアクセスするには「VPCエンドポイント」を利用します。

VPCエンドポイントにはゲートウェイ型とAWS PrivateLink（インターフェイス型）があり、Amazon CloudWatch Logsへの接続は「AWS PrivateLink」を利用します。PrivateLinkは、CloudWatch LogsやS3など多数のサービスで利用できます。

なお、CloudWatch Logsは、AWSサービスやEC2インスタンスのOSやアプリケーションのログを収集し、一元管理するサービスです。

## Egress-Onlyインターネットゲートウェイ

- NATゲートウェイとインターネットゲートウェイの特徴を併せ持つIPv6専用の機能
- VPCからインターネットへ（Egress）の接続開始要求は通しますが、インターネットからVPCへ（Ingress）の接続開始要求は通さない

