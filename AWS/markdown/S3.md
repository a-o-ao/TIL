# Amazon S3

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/Welcome.html

## ストレージクラス

| ストレージクラス                     | 用に設計                                                                 |
|----------------------------------|--------------------------------------------------------------------------|
| スタンダード                       | ミリ秒単位のアクセスが可能で、アクセス頻度の高いデータ（1か月に1回以上）                  |
| Intelligent-Tiering              | アクセスパターンが変化したり不明であるデータ                                              |
| 標準-IA                          | ミリ秒単位のアクセスが可能で、アクセス頻度の低いデータ（1か月に1回）                        |
| 1ゾーン-IA                       | 1つのアベイラビリティーゾーンに保存され、ミリ秒単位のアクセスが可能な再利用可能でアクセス頻度の低いデータ（1か月に1回） |
| Glacier Instant Retrieval        | ミリ秒単位で瞬時に取得可能で、アクセスが四半期に一度の長期利用が多いアーカイブデータ            |
| Glacier Flexible Retrieval（旧Glacier） | 取得時間が数分から数時間で、アクセスが1年に一度の長期利用が多いアーカイブデータ                |
| Glacier Deep Archive            | 取得時間が数時間で、アクセスが1年に1回未満の長期保存向きアーカイブデータ                        |

## S3のパフォーマンス向上

### プレフィックス
プレフィックスを利用して日付ベースでアップロードを分散することで少なくとも 3,500 リクエスト/秒、データの取得で 5,500 リクエスト /秒をサポートできるようにパフォーマンスを自動的に向上させることができます。

## オブジェクトロック

保存されているデータが削除されない方法には2種類ある。

- Amazon S3バケットにMFA Delete機能を適用して、ユーザーによるデータ削除時にMFA入力を必須化して、誤った削除を防止する。
- Amazon S3バケットの初期設定でデータが削除されないS3バケットをロックする。

オブジェクトロックは 保持モード（Retention Mode） と リーガルホールド（Legal Hold）　の2つのモードがあり、
保持モードはさらに コンプライアンスモード と ガバナンスモード がある。

| モード                   | 特徴                                                                                 | ユースケース                                |
|------------------------|----------------------------------------------------------------------------------------|---------------------------------------------|
| **ガバナンスモード**     | 特定の権限を持たないユーザーに対して、指定した期間オブジェクトを読み取り専用にする。権限を持つユーザーのみオブジェクトの更新・削除と、ガバナンスモードの解除ができる。 | 誤削除防止、管理者の制御権限を残す場合        |
| **コンプライアンスモード** | ルートユーザーを含む全てのユーザーに対して、指定した期間オブジェクトを読み取り専用にする。保持期間中はルートユーザーを含めてコンプライアンスモードを解除できない。 | 法的要件や監査対応が必要なデータ              |
| **リーガルホールド**     | 保持期間に依存せず、無期限で削除を防止。特定の権限を持たないユーザーに対して、リーガルホールドを解除するまでオブジェクトを読み取り専用にする。管理者が手動で解除可能  | 訴訟中や法的義務によりデータ保護が必要な場合  |

- オブジェクトロックはバケット作成時にのみ有効化でき、その後の変更は不可能
- S3バッチオペレーションを使用して既存のオブジェクトをロックすることができる。その場合、バケットがロック機能が有効である必要がある。

### S3バッチオペレーション

S3バッチオペレーションは、S3のオブジェクトに対して大規模なバッチ処理を実行するための機能です。操作対象のリストに基づき、コピー、タグ付け、ACL変更、ストレージクラス変更、カスタムLambda関数の呼び出しなどが可能です。S3バッチオペレーションを使用することで、大量のオブジェクトに対する一括処理をサーバーレスに実行でき、運用の効率化が図れます。

## 暗号化方式

| 暗号化方式                         | 説明                                                                 |
|-----------------------------------|----------------------------------------------------------------------|
| **S3管理の暗号化（SSE-S3）**        | S3が自動的にオブジェクトを暗号化し、暗号化キーを管理。デフォルトの暗号化方式。 |
| **サーバーサイド暗号化（SSE-KMS）**  | AWS Key Management Service (KMS) を使って暗号化キーを管理。より高度な管理が可能。 |
| **サーバーサイド暗号化（SSE-C）**   | ユーザーが提供する暗号化キーを使ってオブジェクトを暗号化。AWSはキーを保持しない。 |
| **クライアントサイド暗号化**        | ユーザーがオブジェクトをアップロード前にローカルで暗号化し、S3に保存。 |

### 🔑 **S3の暗号化方式ごとのキー管理とローテーション**

| 暗号化方式                         | キーの管理者           | キーのローテーション方法                                                                                     |
|-----------------------------------|------------------------|-------------------------------------------------------------------------------------------------------------|
| **S3管理の暗号化（SSE-S3）**        | AWS                     | AWSが自動的にローテーション。ユーザーが直接操作することはできません。                                           |
| **サーバーサイド暗号化（SSE-KMS）**  | AWS KMS（ユーザーが管理） | ユーザーがKMSキー（CMK）を管理。自動ローテーション（年1回）を有効にでき、手動操作も可能。                         |
| **サーバーサイド暗号化（SSE-C）**   | ユーザー                 | ユーザーが完全に管理し、ローテーションも手動で実施。キーが変わるときは再アップロードが必要。                     |
| **クライアントサイド暗号化**        | ユーザー                 | ユーザーがローカルでキーを管理し、ローテーションも手動で実施。暗号化・復号もローカルで行う。                     |

---

#### 💡 **ポイント**
- **SSE-S3** はAWSがすべて自動管理しており、キー操作権限はユーザーにありません。  
- **SSE-KMS** ではユーザーがキー操作権限を持ち、自動ローテーションの設定や手動更新が可能です。  
- **SSE-C** と **クライアントサイド暗号化** はユーザーがフルコントロールし、ローテーション管理もすべて手動です。  



## クロスリージョンレプリケーション

S3クロスリージョンレプリケーションは、異なるAWSリージョン間でオブジェクトを自動的に複製する機能です。<br>
特定のS3バケットから別のリージョンのS3バケットへデータをコピーできます。

### 特徴
- 非同期レプリケーション
  - データは非同期的にレプリケーションされ、コピー元とコピー先が完全に同期されるわけではありません。
- バケット間でリージョンが異なる必要がある
  - 同一リージョンへのレプリケーションはサポートされていません。
- バージョニングが必須
  - レプリケーション元バケットとレプリケーション先バケット両方でバージョニングが有効である必要があります。
- フィルタリングが可能
  - プレフィックスやタグを使ってレプリケーション対象を絞り込むことができます。

### ユースケース
- 災害対策 (DR: Disaster Recovery)
  - 地理的に離れたリージョンにデータを複製して、障害時にデータを保護。
- パフォーマンス向上
  - 利用者の近いリージョンにデータを配置し、レイテンシーを削減。
- データ主権対応
  - データを特定のリージョンに保存する法規制への対応。

### クロスリージョンレプリケーション（CRR）の設定

1. S3バージョンイングを有効にする
2. ソースバケットの管理設定においてレプリケーションルールを追加し、宛先バケットを指定する
3. 宛先バケットのバケットポリシーを作成して、オブジェクトの所有権を宛先 S3 バケットの所有者に変更する。

## バージョン管理

S3オブジェクトの各バージョンを保存し、削除や更新を行った際にも過去のバージョンにアクセスできます。<br>
バージョン管理を有効にすると、同じオブジェクト名でも異なるバージョンのデータを保持できます。

| 設定                         | IAMユーザーが削除可能？ | 備考                                         |
|----------------------------|--------------------------|----------------------------------------------|
| バージョニングのみ          | ✅ 可能（削除マーカーが付くだけ） | オブジェクトの旧バージョンは保持される         |
| バージョニング + MFA Delete | ❌ 不可（ルートユーザー + MFA のみ） | より強固な削除制御、バージョニング無効化も不可 |

## ライフサイクル管理

S3オブジェクトの保存期間に基づいて、オブジェクトの自動移行や削除を管理できます。
<br>例えば、一定期間経過したオブジェクトを Glacier に移行する、あるいは古いオブジェクトを削除するなどの設定が可能です。

S3のライフサイクル管理では、特定のバージョン（旧バージョン）だけを対象に自動的に処理を行うことが可能です。具体的には、バージョン管理を有効にしているバケットにおいて、ライフサイクルルールを作成する際に以下のように指定できます。

### 旧バージョンのみのライフサイクル管理
- 旧バージョンのみを削除する
  - ライフサイクルルールで、特定の期間を過ぎた削除されたオブジェクトのバージョン（Delete Marker）や以前のバージョンを削除することができます。

- 旧バージョンのアーカイブ
  - 古いバージョンのオブジェクトを安価なストレージ（例えば S3 Glacier）に自動的に移行するような設定も可能です。

#### 設定例
- 特定のバージョンを削除
    - 「バージョン管理」設定が有効なバケットで、旧バージョンに対してライフサイクルルールを適用して、指定した期間後に削除できます。
- 削除マーカーを自動削除
    - 削除マーカー（オブジェクトを削除したことを示す特殊なオブジェクト）を指定した期間が過ぎると自動で削除するように設定することも可能です。

## Amazon S3 バケットの分析機能

| 分析機能                        | 目的                                                    | 特徴                                                                 |
|---------------------------------|-------------------------------------------------------|----------------------------------------------------------------------|
| **S3 Analytics - Storage Class Analysis** (ストレージクラス分析) | オブジェクトの最適なストレージクラスを分析              | アクセスパターンに基づいて、データを適切なストレージクラスに移動するための提案を提供 |
| **S3 Inventory**                | バケット内のオブジェクトメタデータを定期的に取得        | 定期的にオブジェクト情報をCSV、ORC、Parquet形式でエクスポートし、データ状態を把握    |
| **S3 Access Analyzer**          | アクセス許可を分析し、適切な設定を確認                 | 不適切なアクセス権限の設定を検出し、セキュリティを強化                      |
| **S3 Select**                   | オブジェクトのデータにSQLクエリを実行                   | オブジェクト内の一部データをSQLクエリで抽出し、効率的に分析を実施               |
| **S3 Event Notifications**      | バケット内でのイベントをトリガーとして通知を送信        | オブジェクトの変更（作成、削除など）に基づき、SNS、SQS、Lambdaで通知              |
| **S3 Batch Operations**         | バケット内のオブジェクトに一括操作を実行               | 大量のオブジェクトに対して一括でタグ付け、ストレージクラスの変更、削除を実行        |
| **Amazon Athena**               | S3のデータに対してSQLクエリを実行                     | サーバーレスで直接データに対してSQLクエリを実行し、分析を行う                      |
| **Amazon QuickSight**           | S3データを視覚化し、ダッシュボードを作成               | インタラクティブなビジュアルダッシュボードを作成し、分析結果を視覚化                |

## イベント通知

Amazon S3 のイベント通知設定では、以下のAWSサービスを指定します。

- Amazon Simple Notification Service (Amazon SNS) のトピック
- Amazon Simple Queue Service (Amazon SQS) キュー
- AWS Lambda 関数
- Amazon EventBridge

## 静的WEBホスティング

S3バケットを用いて静的ウェブサイトを構築するには、まずS3バケットで静的ウェブホスティング機能を有効にする必要があります。次に、Index.htmlを設定することでウェブサイトの構成が完了します。さらに、このウェブサイトを一般のユーザーに表示させるためには、インターネットからのアクセスを許可する設定が求められます。そのためには、パブリックアクセスブロックを無効にし、バケットポリシーを設定してインターネットからのs3:GetObjectを許可する必要があります。

### 静的WEBホスティングのフロー

1. ブロックパブリックアクセスを無効化する
    - S3バケットの設定で、「ブロックパブリックアクセス」を無効にして、バケット内のオブジェクトがインターネットからアクセス可能になるようにします。
2. バケットポリシーでバケットの読取許可を設定する
    - バケットポリシーで、全てのユーザーに対して「`s3:GetObject`」アクション（読み取り権限）を許可します。これにより、Webサイトのコンテンツを公開できます。
3. index.htmlなどのインデックスドキュメントをバケット内に保存する
    - インデックスドキュメント（例：index.html）や必要なファイル（CSS、JavaScript、画像など）をバケットにアップロードします。
4. 静的WEBホスティングの設定画面でindex.htmlなどのインデックスドキュメントを設定し、有効化する
    - 「静的Webサイトホスティング」の設定を有効にし、インデックスドキュメントを指定します（例：index.html）。これにより、URLにアクセスしたときに表示されるページが設定されます。

## アクセス制御
### ACL（アクセスコントロールリスト）
- AWSアカウント単位でアクセス権限を設定する機能
- 他のAWSアカウントに対して、S3バケットやオブジェクトへの読み取りまたは書き込みを許可する
- アクセス元のIPアドレスやドメイン単位でのアクセス制御はできない

### バケットポリシー
- バケット単位でアクセス権限を設定するリソースベースのポリシー
- 自AWSアカウントのIAMユーザーや他のAWSアカウントに対して、オブジェクトもしくはバケットへアクセス権限を設定
- アクセス元のIPアドレスやドメイン単位でのアクセス制御ができる
- S3バケットへのアクセス元をVPCエンドポイントに限定するには「バケットポリシー」を利用

### IAMポリシー
- IAMユーザー単位でアクセス権限を設定するIDベースのポリシー
- 他のAWSアカウントにはアクセス権限を設定できない

## 所有権
- アップロードしたAWSアカウントが所有権を持つ
- バケットの所有者はオブジェクトに対してフルコントロール権限がない
  - バケットの所有者にフルコントロール権限を付与するには、アップロードしたAWSアカウントがオブジェクトのアップロード時に、バケットの所有者にフルコントロール権限を付与する設定する(バケットポリシーで設定する)

## アーカイブのデータ取り出し

### 大容量(バルク)取り出し
- 標準取り出しより時間がかかるが、料金が低価格になる
- ペタバイト単位のデータを1日かけて取り出す

## S3 Transfer Acceleration

- ユーザーからS3バケットへ最適化したネットワークルートを経由してデータを転送する機能
- ユーザーと地理的に近いエッジロケーションから高パフォーマンスなAWSネットワークを経由してS3バケットへアクセスするため、遅延の発生やデータ損失などのリスクを少なくする。

## S3 Object Lambda

S3 Object Lambdaは、S3オブジェクトをリアルタイムでカスタマイズする機能です。S3 Object Lambdaでは、S3 Object Lambdaアクセスポイントを、Lambda関数とS3バケットに作成したS3アクセスポイントに紐づけます。S3 Object Lambdaアクセスポイントを経由したS3オブジェクトへのリクエストをトリガーとして、Lambda関数を実行し、処理後のデータを返すことができます。

リアルタイムでフィルタリング、圧縮、再フォーマット、データ加工などの処理が可能で、オブジェクトを動的に修正や変換できます。元のデータに変更を加えることなく、S3オブジェクトへのアクセス時に自動的にデータ処理を適用できるため、柔軟性と効率性が向上します。

![image](https://ping-t-resouces.com/uploads/question_image/file/26561/k65739.jpg?t=1720242621)

## S3イベント通知

S3バケットに発生したイベント（オブジェクトの作成や削除など）をトリガーに通知を行う機能です。

通知先はLambda関数、SQSキュー、SNSトピック、EventBridge。<br>
SageMaker Pipelinesへ通知するには、EventBridgeを経由する必要がある
