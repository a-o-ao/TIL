# Amazon SQS

## キューの詳細設定

| キュータイプ           | 説明                                                    | ユースケース                                             |
|-------------------|-------------------------------------------------------|-------------------------------------------------------|
| **遅延キュー（Delay Queue）**  | メッセージの送信から**指定した遅延時間後**にメッセージがキューに配信される。 | - 何らかの処理を遅らせる必要がある場合<br>- イベントの遅延実行が必要な場合 |
| **優先度付きキュー（Priority Queue）** | SQSには標準的な優先度付きキューの機能はなく、実装には**FIFOキュー**や**カスタム処理**が必要。 | - 高優先度のタスクを優先的に処理する必要がある場合 |
| **デッドレターキュー（DLQ）** | 処理できなかったメッセージを**指定した回数以上**失敗した後に転送するキュー。 | - メッセージの処理失敗を監視し、再処理する必要がある場合<br>- エラーログの収集やトラブルシューティング |

優先付けには次のような設定を行います。

1. SQSを用いて優先順位ごとに複数のキューを用意する。
2. 処理を急ぐリクエストは優先順位の高いキューに入れる。
3. 優先順位に応じてキューを処理するサーバー台数を用意する。
4. キューの「メッセージの遅延送信」機能を利用することで、処理開始時間を遅延させることも可能である。

## Amazon SQS に基づくスケーリングポリシー

https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/as-using-sqs-queue.html

1. SQS キューのバックログを監視
    - Amazon SQS に蓄積されたメッセージの数（バックログ）を Amazon CloudWatch に送信。
    - CloudWatch で 「インスタンスごとのバックログ」 をカスタムメトリクスとして記録。

2. Auto Scaling による動的スケーリング
    - CloudWatch のカスタムメトリクスを元に ターゲット追跡スケーリングポリシー を適用。
    - メトリクスが増加（バックログ増） → 新しいインスタンスを起動（スケールアウト）。
    - メトリクスが減少（バックログ減） → 不要なインスタンスを終了（スケールイン）。
    
3. 処理サーバーが SQS のメッセージを処理
    - Auto Scaling Group の 処理サーバーが SQS からメッセージを取得し処理。
    - インスタンス数は SQS のバックログ状況に応じて自動調整される。

💡 この仕組みのメリット
- SQS の負荷に応じてインスタンスを自動で増減 → コスト最適化 & 高可用性
- CloudWatch のカスタムメトリクスを利用 → 柔軟なスケーリングポリシーが設定可能

➡ Amazon SQS を使ったイベント駆動型の Auto Scaling を実装する際に有効なアーキテクチャ！ 

## SQSメッセージについて

#### メッセージの制約
- メッセージ数は無制限に利用可能
- メッセージサイズは最大256KB
- 拡張クライアントライブラリーを利用すると2GBまでのメッセージのやり取りが可能

#### メッセージの保持期間
- SQSのキューメッセージは保持期間内は保存される
- デフォルト4日間（最小60秒～最大14日で設定可能）
- アプリケーションでメッセージ削除を行わないと、保持期間超過までキューが滞留する

