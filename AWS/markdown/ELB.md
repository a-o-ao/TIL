# ELB

## ELBの主要機能

| 機能名               | 説明                                                                                     |
|--------------------|--------------------------------------------------------------------------------------------|
| ヘルスチェック       | EC2インスタンスの正常／異常を確認し、利用するEC2の振り分けを行う                             |
| クロスゾーン負荷分散 | 配下のEC2の負荷に応じて、複数のAZに跨るEC2インスタンスに均等に負荷分散を行う                 |
| 暗号化通信           | SSL/TSL証明書をELBに設定することでHTTPSまたはTLS通信を実施することができる                   |
| スティッキーセッション | セッション中に同じユーザから来たリクエストを継続して同じEC2インスタンスに送信する               |
| Connection Draining | インスタンスが登録解除されるか異常が発生した場合に、そのバックエンドインスタンスへの新規リクエスト送信を中止する |
| ログ取得             | ELBのログ取得を有効化するとS3バケットにログを収集                                           |


### UnhealthyHostCount

`UnhealthyHostCount` は、AWSのロードバランサー（特にELB: Elastic Load Balancing）で使用されるメトリクスの1つです。<br>
ロードバランサーによって検出された 「非正常（Unhealthy）」なバックエンドインスタンス（ホスト）の数 を示します。

- 主なポイント
  - 監視対象は、ロードバランサーに登録されているすべてのインスタンスです。
  - ヘルスチェックの結果が「非正常」と判定されたインスタンスの数がカウントされます。
  - 監視を通じて異常が検出された場合、トラフィックは他の正常なインスタンスに振り分けられます。
  - CloudWatchメトリクスとして監視でき、アラームを設定することで自動対応も可能です。

## **ALB（Application Load Balancer）のリスナー設定オプション**

### **① リスナーの基本設定**
#### **プロトコル & ポート**
- **HTTP（80）**  
  - 通常のWebトラフィック用（HTTPSへのリダイレクト可能）。  
- **HTTPS（443）**  
  - **SSL/TLS証明書を適用できる**（AWS Certificate Manager（ACM）などで管理）。  
- **gRPC**  
  - HTTP/2ベースのリモートプロシージャコール（RPC）を処理可能。  
- **TLS（SSLの後継）**  
  - **TCPレベルでの暗号化が必要な場合に使用**（通常はNetwork Load Balancer向け）。  

---

### **② リスナーのオプション（リスナールール & アクション）**
リスナーには、リクエストをどのように処理するかを決める「**リスナールール**」を設定できます。

#### **アクション（リクエストの処理方法）**
| **アクション**          | **概要** |
|-----------------------|------------------------------------------------|
| **転送（Forward）**   | 指定した **ターゲットグループ（EC2, ECS, Lambdaなど）** にリクエストを転送する。|
| **リダイレクト**      | **HTTP → HTTPS へのリダイレクト** や、別のURLへのリダイレクトが可能。|
| **固定レスポンス**    | **特定のレスポンス（例: 403 Forbidden）を返す**（メンテナンス時などに利用）。|
| **認証（Authenticate）** | **Cognito / OIDCプロバイダーを使った認証を適用** し、認証後にターゲットへ転送。|

---

### **③ 条件付きルール（リクエストのルーティング条件）**
リスナールールでは、特定の条件に応じて異なる処理を適用できます。

| **条件の種類**       | **概要** |
|--------------------|------------------------------------------------|
| **ホストヘッダー** | `example.com` や `api.example.com` など、ドメインごとに振り分ける。|
| **パスベース**     | `/api/*` → API用のバックエンド、`/app/*` → Webアプリ用にルーティング可能。|
| **クエリ文字列**   | `?user=admin` のようなクエリパラメータに基づいて振り分け可能。|
| **HTTPヘッダー**   | `User-Agent` などの特定のヘッダー値でルーティング。|
| **リクエストメソッド** | `GET`, `POST` などのHTTPメソッドごとに処理を変更。|
| **ソースIPアドレス** | 特定のIPレンジ（CIDR）からのアクセスに対してルールを適用可能。|

---

### **④ SSL/TLS 設定（HTTPSリスナーのみ）**
HTTPSリスナーを設定する場合、**SSL/TLS証明書とセキュリティポリシーを設定**できます。

- **SSL証明書の設定**（ACMまたはIAMで管理）
- **TLSポリシーの設定**（セキュリティ強度を調整）
  - `ELBSecurityPolicy-2023-04`（最新の推奨ポリシー）
  - `ELBSecurityPolicy-TLS-1-2-2017-01`（TLS 1.2 のみ有効）
  - `ELBSecurityPolicy-TLS-1-1-2017-01`（TLS

## その他

### ELBでHTTPSを有効化 & EC2のデータ暗号化
- ELBでHTTPSを利用するには、ACMのSSL/TLS証明書を設定し、リスナーでHTTPSプロトコルを有効化する
- HTTPS通信により、クライアントとELB、ELBとEC2間の通信が暗号化される
- EC2のデータ暗号化には、EBSボリュームの暗号化を有効にする必要がある

### SNI（Server Name Indication）

- 暗号化通信で使用するサーバー証明書をパブリックIPアドレスではなくドメイン名によって判断する技術
- SNIに対応したELBに複数のサーバー証明書を導入すると、ELBが宛先ドメイン名から適切なサーバー証明書を判断してサーバーへ通信を転送する
- ALB, NLB が対応

![image](https://ping-t-resouces.com/uploads/question_image/file/22887/k58466.jpg?t=1661918029)

### 暗号化

クライアントとELB間で通信を暗号化し、ELBとターゲット間は平文の通信（暗号化されていない通信）を行う方法

![image](https://ping-t-resouces.com/uploads/question_image/file/22884/k58488.jpg?t=1708578744)


クライアントとALB間、ALBとインスタンス間で別の暗号化通信を行う方法

![image](https://ping-t-resouces.com/uploads/question_image/file/22885/k58487.jpg?t=1708578744)

NLBではHTTPS通信を処理せずにインスタンスへHTTPS通信を転送

![image](https://ping-t-resouces.com/uploads/question_image/file/22886/kk58487.jpg?t=1661918029)


### 登録解除の遅延

デフォルトにより、Application Load Balancer は登録解除プロセスが完了するまで 300 秒待機して、ターゲットへ処理中のリクエストを完了しやすくします。Application Load Balancer が待機する時間を変更するには、登録解除の遅延値を更新します。
