# AWS Auto Scalling

https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html

Auto Scaling自体はAuto Scaling グループを作成して使用し、対象のリソース（EC2やECSサービスなど）に対してアタッチします。
適切なスケーリングポリシーを設定することで、リソースの自動管理が可能になります。

## 対象リソース
- EC2
- ECS
- EKS (クラスター: EKS Cluster Autoscaler/ PoD: Horizontal Pod Autoscaler)
- ALB
- RDS
- ElastiCache
- DynamoDB
- Aurora
  - ✅ Aurora Replicas Auto Scaling → リードレプリカの自動増減
  - ✅ Aurora Serverless v2 → CPUやメモリを柔軟にスケール
  - ❌ プライマリインスタンスのスケールアウトは不可（スケールアップのみ可能
- SageMaker

### EC2のAuto Scalling
- EC2のスケールアウト時は起動テンプレートで設定したインスタンスが起動する
- Auto Scalingのヘルスチェックのタイプには「EC2」と「ELB」がある
  - デフォルトでは「EC2」が有効、「ELB」は無効
  - 「EC2」「ELB」ともに有効にすることが推奨

## 🚀 スケーリングポリシーの種類

| ポリシータイプ                        | 特徴                                                                                 | ユースケース                                                                             |
|------------------------------------|---------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|
| 動的スケーリング (Dynamic Scaling)     | 負荷に応じて**リアルタイムでスケーリング**。CloudWatchのメトリクスに基づき自動的に増減。      | CPU使用率が一定以上になったら増加、一定以下になったら減少させる                              |
| 予測スケーリング (Predictive Scaling) | **過去のパターンを学習**し、**将来の需要を予測**してスケーリング。                         | 定期的なトラフィック変動（例：平日と週末で異なるトラフィック）に対応                           |
| スケジュールスケーリング (Scheduled Scaling) | あらかじめ決めた**日時に合わせてスケーリング**。                                         | 毎日18時に増やし、24時に減らすなど、定時に対応したい場合                                        |
| 手動スケーリング (Manual Scaling)     | 管理者が**手動でインスタンス数を変更**。                                                 | 予期しない負荷が発生したときに緊急対応として使用                                             |

### 💡 動的スケーリングのポリシータイプ

| ポリシータイプ                                | 説明                                                                                          | 例                                                                                   |
|--------------------------------------------|-----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|
| シンプルスケーリング (Simple Scaling)         | 条件が満たされたときに**一定数のインスタンスを増減**させるポリシー。シンプルだが遅延が発生しがち。 | CPU使用率が80%を超えたら**1台追加**                                                      |
| ステップスケーリング (Step Scaling)           | 条件の程度に応じて**増減数を柔軟に制御**できる。ステップごとに異なる増減数を設定。                 | CPU使用率が70%なら1台、90%なら3台を追加                                                     |
| ターゲット追跡スケーリング (Target Tracking Scaling) | 特定のメトリクス（例：CPU使用率）を**一定の目標値に維持**するようにスケーリング。                         | CPU使用率50%を目標にして、適宜インスタンスを増減                                              |

※ メモリ利用率をトリガーとした設定がデフォルトでは設定できないようになっています。したがって、CPU利用率に応じたスケーリングが適切な設定となります。

### Auto Scaling グループの容量制限を設定する

| 項目                     | **希望するキャパシティ**                                | **最少キャパシティ**                               | **最大キャパシティ**                               |
|--------------------------|------------------------------------------------------|-------------------------------------------------|--------------------------------------------------|
| **定義**                  | Auto Scaling グループが維持する望ましいインスタンス数 | Auto Scaling グループが保持する最小インスタンス数 | Auto Scaling グループが許容する最大インスタンス数 |
| **役割**                  | 実際に稼働するインスタンス数の目標値                  | インスタンス数がこれより少なくならないようにする   | インスタンス数がこれを超えないようにする         |
| **スケーリングの調整**    | スケーリングポリシーに基づいて動的に調整される       | インスタンス数がこれ未満にならないように維持      | インスタンス数がこれ以上には増加しないように維持 |
| **設定例**                | 例えば、希望するキャパシティを 3 に設定すると、3 インスタンスを維持 | 例えば、最少キャパシティを 2 に設定すると、インスタンス数が 2 以下にはならない | 例えば、最大キャパシティを 10 に設定すると、インスタンス数が 10 を超えない |


## ELBとAuto Scalingの連携方法

1. Auto ScalingグループにELBを関連付ける
    - Auto Scalingグループを作成する際に、ターゲットとして`ロードバランサー（ALBやCLBなど）`を指定します。
    - スケーリングで追加・削除されたEC2インスタンスが、自動的にELBに登録・解除されます。
2. ヘルスチェックの統合
    - ELBでヘルスチェックを実施し、異常が検出されたインスタンスをAuto Scalingが自動で置き換えます。

## ターミネーションポリシー

Auto Scaling のターミネーションポリシーとは、スケールイン（インスタンス削減）時にどのインスタンスを優先的に終了するかを決めるルール

| ターミネーションポリシー         | 特徴                                                                                           |
| -------------------------------- | ---------------------------------------------------------------------------------------------- |
| Default                          | 最も古いLaunch TemplateやConfigurationを持つインスタンスを優先して終了します。                     |
| OldestInstance                   | スケーリンググループ内で**最も古いインスタンス**を優先して終了します。                              |
| NewestInstance                   | スケーリンググループ内で**最も新しいインスタンス**を優先して終了します。                            |
| OldestLaunchConfiguration         | **最も古いLaunch Configuration**を持つインスタンスを優先して終了します。                            |
| ClosestToNextInstanceHour         | **次の料金時間に近いインスタンス**を終了し、コスト削減を図ります。                                 |
| Default + Allocation Strategy    | **Spot FleetやCapacity Rebalance**のポリシーと併用し、コストや安定性を考慮して終了します。           |

### Auto Scaling フリート

Auto Scaling グループ内のインスタンスを管理し、負荷に応じて自動的にスケーリングします。

## ヘルスチェック

Auto Scaling 配下のEC2ヘルスチェックには、EC2ステータス情報またはELBのヘルスチェックのどちらかを利用する。

- EC2タイプ：EC2のステータスがrunning以外である場合や、システムステータスがimpairedである場合に、そのインスタンスを異常と見なします。
- ELBタイプ：インスタンスのステータスチェックとELBのヘルスチェックを基に、インスタンスの状態を評価します。

## クールダウン

`Auto Scalingグループにおけるクールダウン（Cooldown）`とは、スケーリングアクションが完了してから次のスケーリングアクションが実行されるまでの待機時間を指します。これにより、頻繁なスケーリングアクションを防ぎ、リソースの過剰な追加や削減を抑制します。

- 目的
  - スケーリングアクションの過剰実行を防止し、リソースの安定化を図るため。
  - 短時間に複数回のスケーリングが実行されることによるコスト増加やリソースの不安定化を防ぐ。
- 仕組み
  - インスタンスの起動または終了が完了すると、クールダウン期間が開始します。
  - クールダウン期間中は他のスケーリングアクションがブロックされます。
- デフォルト設定
  - デフォルトでは`300秒（5分）`に設定されていますが、必要に応じて調整可能です。
- クールダウンの種類
  - 一般クールダウン（Auto Scalingグループ全体に適用）
  - ポリシーごとのクールダウン（特定のスケーリングポリシーにのみ適用）

※スケールインクールダウン期間中に別のアラームがスケールアウトアクティビティを引き起こした場合、Application Auto Scalingによってターゲットは即座にスケールアウトされます。この場合、スケールインクールダウン期間は中断され、完了しないことになります。

## スケーリングメトリクス

- ASGAverageCPUUtilization – Auto Scaling グループの平均 CPU 使用率。

- ASGAverageNetworkIn – すべてのネットワークインターフェイスで Auto Scaling グループが受信した平均バイト数。

- ASGAverageNetworkOut – すべてのネットワークインターフェイスで Auto Scaling グループが送信した平均バイト数。

- ALBRequestCountPerTarget – Application Load Balancer ターゲットグループ内のターゲットごとに完了したリクエストの数。

## Auto Scalingウォームプール

事前に起動済みのインスタンスをプールしておくことで、スケールアウト時の起動時間を短縮できる仕組み。

### ✅ 特徴

- スケールアウト時にインスタンスの起動や初期化を短縮できる
- 待機状態（Stopped または Running）で事前にインスタンスを確保
- Amazon EC2 Auto Scaling グループで使用可能

### 🔍 メリット

- トラフィック急増時でも素早くスケール対応
- アプリやミドルウェアの初期化が重いケースに最適
- ユーザー体験の改善（起動遅延の回避）

### 📌 ユースケース例

- 起動時間が長いアプリケーションを含むEC2環境
- 定期的にアクセス急増があるサービス（セール、イベントなど）
- ミッションクリティカルなバッチ処理やAPIバックエンド

### ⚠️ 注意点

- ウォームプール内のインスタンスも状態に応じてコストがかかる
- サイズの設定を適切に行う必要がある（コストと性能のバランス）


