# IAM

### EC2 インスタンスにIAMロールをアタッチする方法

- EC2 に IAM ロールを渡すための仕組みが`インスタンスプロファイル`
- IAM ロールを通じてEC2インスタンスが AWS リソースにアクセス可能
- AWS CLI や SDK を使うと、自動的にロールの権限を使用できる
- アクセスキーを使う方法よりも安全！

### IDフェデレーション

外部のIDプロバイダーを通じて認証を行い、AWSリソースへのアクセスを制御する仕組み<br>
これにより、ユーザーは複数のサービスに対してシームレスにアクセスでき、管理者はアクセス権限を一元的に管理できます。

#### 代表的なIDフェデレーションの方法：
- **SAMLフェデレーション** → SAML 2.0に対応したIdP（例: Microsoft Entra ID, Okta）を利用
- **OIDCフェデレーション** → OIDC対応のIdP（例: Google, Amazon Cognito）を利用
- **カスタムフェデレーション** → AWS STS（Security Token Service）を活用して、一時的なアクセス権を発行

## ユーザーベースのポリシータイプ
**IAMポリシーを作成してユーザーなどへのアクセス権限を付与**

https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/access_policies_managed-vs-inline.html

### 管理ポリシー
#### 【AWS管理ポリシー】
AWSが作成および管理する管理ポリシー

#### 【カスタマー管理ポリシー】
AWSアカウントで作成・管理する管理ポリシー。  
同じポリシーを複数のIAMエンティティにアタッチできる。

### インラインポリシー
**ユーザーが作成および管理するポリシー**  
1つのプリンシパルエンティティ（ユーザー、グループ、またはロール）に埋め込まれた固有ポリシーで、プリンシパルエンティティにアタッチすることができる。

## AWSアカウント（ルートユーザー）
- MFA（多要素認証）を有効化する
- アクセスキーとシークレットアクセスキーを削除する

## 信頼ポリシー（信頼関係の設定）

- AWSアカウント間でリソースへのアクセスを許可する際に、資格情報（ユーザー名とパスワードやアクセスキーとシークレットキーなど）の共有というセキュリティリスクを避けるための手段
- 資格情報の共有は、漏洩リスクを伴うので非推奨
- IAMロールに信頼ポリシーを設定することで、他のAWSアカウントやサービスが指定されたロールの権限を一時的に利用することが可能になる
  - ロールの引き受けを許可するため、AWS STSのAPI「AssumeRole」を使用します。これをIAMポリシーのActionとして指定します。


## その他

### ARN

arn:aws:<SERVICE>:<region>:<account>:<resource>

例) arn:aws:dynamodb:us-east-1:123456789012:table/Cats

### Permissions Boundary（アクセス許可境界）

IAMユーザーやIAMロールの操作可能範囲を限定し、「指定された範囲内でのみ操作が可能」という制約を設ける機能です。この制約により、設定された範囲とIAMポリシーによって許可されたアクションのみが実行可能となります。

例えばLambda関数の作成をしている開発者に対して、必要なリソースへのアクセス権は都度自由に設定できるようにしておきたいが、開発者自身のアクセス権を操作させたくないようなケースで有用

### カスタムIDブローカーアプリケーション

一般的にSSOを実現するためにはSAMLを使って認証するが、SAMLと互換性のないADの場合、
代替手段として`カスタムIDブローカーアプリケーション`を開発する必要がある。

カスタムIDブローカーは、異なる認証システム間で橋渡しを行い、STSを利用して一時的なAWS認証情報を取得することでAWSへ認証することができる。
