# Amazon DynamoDB

https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/Introduction.html

## ストレージクラス

### 1. Standard（標準ストレージクラス）

- デフォルトで使われるストレージ
- 高頻度アクセス向け
- 読み書きコストがバランス良く設計されている
- どのアイテムでも自動的にこのクラスが適用される（明示的に変えなければ）

### 2. Standard-IA（Standard – Infrequent Access）

- アクセス頻度が低いデータ向け
- ストレージコストが安い（Standard の約 1/3）
- 読み取りコストが高め（3倍くらい）

#### 補足
- オンデマンドモード／プロビジョンドモード 両方で使用可能
- テーブル単位ではなく、アイテム単位での自動移行も可能

## 課金方式

### オンデマンドモード（オンデマンドキャパシティ）
- リクエスト単位の従量課金（RCU/WCU の設定不要）
- 突然のアクセス急増にも柔軟に対応
- 小規模 or アクセス量不定なアプリにおすすめ
- 単価は少し高め

### プロビジョニングモード（プロビジョンドキャパシティ）
- RCU（読み込み）と WCU（書き込み）を設定
- 使ってなくてもキャパシティ分は課金される
- `Auto Scaling を併用`すると柔軟に対応可能

#### 具体例（プロビジョンドモード）
たとえば、以下のように設定したとします：
- RCU: 100、WCU: 50

このとき、1 秒あたりに処理できるのは…
- 読み込み：最大 100 回（4KB 以下のデータ）
- 書き込み：最大 50 回（1KB 以下のデータ）

これを超えると、スロットリング（制限）されて遅延やエラーが発生する可能性があります。

### リザーブドキャパシティ
- プロビジョンドモードの前払い割引オプション（オンデマンドモードでは使えない）
- キャパシティユニットを大きな単位で購入しておくことで、コストを抑えることができる
- 使わなくても払い戻し不可（ただし長期で割安）
- 例：WCU1000、RCU500 を 1年間契約、など

#### キャパシティユニット

DynamoDBのキャパシティユニットとは、データを読み書きするためのパフォーマンス指標です。
以下の2種類があります。

- 読み取りキャパシティユニット（RCU: Read Capacity Unit）
  - 1秒間に強力な整合性読み取りを1回、または最終的整合性読み取りを2回実行できる能力。
  - サイズ：4KBまでのデータ。
- 書き込みキャパシティユニット（WCU: Write Capacity Unit）
  - 1秒間に1回の書き込み操作を実行できる能力。
  - サイズ：1KBまでのデータ。

## DynamoDB トランザクション機能

DynamoDB トランザクション機能は、DynamoDBテーブルに対する1 つのオペレーションとして複数の項目の追加、更新、または削除が必要となる複雑なビジネスワークフローを管理できます。
DynamoDBのトランザクション機能を使うことで、複数のアイテムを安全に一括処理でき、データの整合性を保つことができます。金融取引や在庫管理など、データの一貫性が重要なユースケースに適しています。

- Put — `PutItem` オペレーションを開始し、条件付きで、または条件をまったく指定せずに、新しい項目を作成するか、古い項目を新しい項目に置き換えます。
- Update — `UpdateItem` オペレーションを開始し、既存の項目の属性を編集するか、まだ存在しない場合は新しい項目をテーブルに追加します。条件付きまたは条件なしで既存の項目で属性を追加、削除、更新するには、このアクションを使用します。
- Delete — `DeleteItem` オペレーションを開始し、プライマリキーにより識別される 1 つの項目をテーブルで削除します。
- `ConditionCheck` — 項目が存在することを確認するか、項目の特定の属性の条件を確認します。

## DynamoDB ストリーム

DynamoDBストリーム（DynamoDB Streams） は、DynamoDBテーブルのデータ変更（追加・更新・削除）をリアルタイムでキャプチャし、他のAWSサービスやアプリケーションで利用できるようにする機能です。

テーブルに対して行われた直近の24時間の変更（追加や更新、削除）をログに保存する機能。ストリームを参照することによって、いつ誰がどのようにテーブルを更新したかがわかる。

※ログは、一時的に(23時間)メモリに取得されるだけなので、永続的に取得されるわけではない。<br>
S3やCloudwatchに保存したい場合はLambdaを介して保存する必要がある。(Lambdaと統合されている)

### 主な特徴
1. データ変更の記録
    - DynamoDBテーブルに対する`書き込み操作（PutItem, UpdateItem, DeleteItem）`をキャプチャ。
    - 変更内容は「ストリームレコード」として保持される。
2. 変更データの取得方法
    - AWS Lambda と連携して処理可能。
    - ポーリング方式でストリームデータを取得。
3. ストリームの保持期間
    - 最大24時間データが保持される。
4. 4つのストリームモード（取得できるデータ）
    - KEYS_ONLY: 変更されたアイテムのプライマリキーのみ。
    - NEW_IMAGE: 変更後のデータのみ。
    - OLD_IMAGE: 変更前のデータのみ。
    - NEW_AND_OLD_IMAGES: 変更前後の両方のデータ。

### ユースケース

- リアルタイムデータ処理
データの変更を検知し、AWS Lambda で`自動処理（通知、分析、集計など）`を実行。
- 監査・ログ管理
変更履歴を S3 や CloudWatch に保存し、監
査ログとして活用。
- データレプリケーション
別の DynamoDB テーブルや他のデータベースへリアルタイムで同期。
- キャッシュの自動更新
`ElastiCache（Redis）`などのキャッシュと連携し、データ変更時にキャッシュを更新。

## 東京リージョンに存在するDynamoDBテーブルのデータがシンガポールリージョンに自動的に複製されるための設定方法

- DynamoDB Streamsを有効にする
  - これにより、東京リージョンのDynamoDBテーブルにおけるデータの更新が発生した際に、シンガポールリージョンのDynamoDBテーブルへ自動的にレプリケーションされる設定が可能となる
- グローバルテーブルを設定する
  - 該当する全てのリージョンに作成されたDynamoDBテーブルに対してグローバルテーブルを設定することで、これらのDynamoDBテーブル間のデータ変更を自動的にレプリケートする。

## ポイントインタイムリカバリ

Amazon DynamoDBのデータを過去最大 35 日前まで遡って復元できる機能です。

### 特徴
- 最大 35 日前までのデータ復元が可能。

- 誤操作やデータ損失に対応（例：誤って削除したデータを復元）。

- 継続的にバックアップされるため、特定の時間の状態に戻すことができる。

- テーブル単位で有効化・無効化できる（デフォルトでは無効）。

- 復元時は新しいテーブルとして作成（既存のテーブルを上書きしない）。

### ユースケース
- 誤ったデータ更新や削除のリカバリ（ユーザーが誤ってデータを消してしまった場合）。

- アプリケーションの障害対応（システム障害発生時に特定時点のデータへロールバック）。

- データの検証や監査（過去のデータ状態を確認するために復元）。

### 注意点
- 無料ではなく、追加料金が発生（DynamoDBのストレージサイズに応じた課金）。

- トランザクション履歴の復元は不可（整合性のあるスナップショットを作成する機能ではない）。

※DynamoDBテーブルにはスナップショットという機能はありません。

### その他
- オンデマンドバックアップはユーザーが任意のタイミングで取得するテーブル全体のバックアップである
- ポイントインタイムリカバリを有効にするとAWSが自動で差分バックアップを行う
- バックアップ処理の間はパフォーマンスへの影響はない

## 読み取り整合性

DynamoDB では、読み取りの整合性を **3つのモード** から選択できます。

https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/HowItWorks.ReadConsistency.html

### **① 最強整合性のある読み取り（Strongly Consistent Reads）**
- **書き込み直後の最新データを保証** して取得できる。  
- **リージョン内のすべてのレプリカ** から最新データを取得するため、遅延がやや高い。  
- **読み取りキャパシティの消費量は 2倍**（Eventually Consistent Read の2倍）。

### **② 結果整合性のある読み取り（Eventually Consistent Reads）**
- **デフォルトの読み取りモード**。  
- 書き込み直後は **古いデータが返る可能性がある**（短時間で最新データに収束する）。  
- **読み取りキャパシティの消費量が少ない（効率的）**。  
- **高いスループットが必要な場合に推奨**。

### **③ トランザクション読み取り（Transactional Reads）**
- **ACID トランザクション対応** の読み取り。  
- **強整合性が保証される**。  
- **書き込みと一緒に利用することで、一貫性のあるデータ処理が可能**。  
- **読み取りキャパシティの消費量は 2倍**（通常の Strongly Consistent Read と同じ）。

### **💡 使い分けのポイント**
| **モード** | **データの一貫性** | **レイテンシ** | **コスト** | **主な用途** |
|------------|-----------------|--------------|------------|------------|
| **最強整合性** | 最新データを保証 | 遅い | 高い | 金融・認証システムなど |
| **結果整合性** | 多少の遅延あり | 速い | 低い | 高スループットが必要な場合（ログ・分析など） |
| **トランザクション** | ACID保証 | 遅い | 高い | 一貫性が求められる複数項目の読み書き |

---

### **🔹 まとめ**
- **デフォルトは結果整合性（高速 & 低コスト）**
- **強整合性はデータの一貫性が必須な場合に使用**
- **トランザクションは ACID 保証が必要な場合に適用**

## PutItem vs. UpdateItem の違い

| 操作 | PutItem | UpdateItem  |
| ---- | ---- | ---- | 
| **用途** | アイテムの新規作成 or 上書き | 	アイテムの一部を更新 |
| **キーの指定** | 必須	 | 必須 |
| **既存データへの影響** | 既存のアイテムを上書き（完全置換） | 指定した属性のみ更新 |
| **条件付き更新** | ConditionExpression で可能 | ConditionExpression で可能 |
| **更新可能な項目** | アイテム全体 | 指定した属性のみ |
| **データが存在しない場合** | 新規作成 | 更新されない（オプションで新規作成可） |
| **コスト** | 書き込み単位（WCU）消費 | 書き込み単位（WCU）消費（変更する属性数による） |

## DynamoDB Accelerator (DAX) の特徴

- インメモリキャッシュを利用することで、応答時間を1桁台のミリ秒からマイクロ秒単位に短縮し、結果の整合性を保ったまま読み込みワークロードを処理できます。また、マルチAZ DAXクラスターは、1秒間に数百万件のリクエストを効率的に処理する能力を備えています。

- DAXは、DynamoDBを利用するAPIと互換性のあるマネージドサービスであり、運用の簡素化やアプリケーションの複雑さを軽減し、導入を容易にします。

- DAXは、読み取りが多いワークロードや急激に増加するワークロードに対して、スループットを向上させるとともに、読み込みキャパシティーユニットを過剰にプロビジョニングしないように設計されており、運用コストの削減に寄与します。

## S3へのエクスポート機能

- 既存のテーブルデータを任意のS3バケットに直接エクスポートする機能
- 対象のテーブルに設定されたRCUを消費せず、テーブルの可用性やパフォーマンスにも影響を及ぼさない
- 実行するためには、対象のテーブルのポイントインタイムリカバリを有効にする
- エクスポート対象のS3バケットは事前に作成しておく必要がある
