# Amazon EC2

## インスタンスタイプ

| カテゴリ                 | インスタンスタイプ           | 特徴 |
|------------------------|---------------------|--------------------------------------------------|
| **汎用（バースト可能）**  | T             | コスト効率が良く、CPUクレジットベースで動作する小規模アプリ向け。 |
| **汎用（スタンダード）**  | M     | バランスの取れた性能で、幅広い用途に対応。 |
| **コンピューティング最適化** | C       | 高いCPU性能が求められる計算集約型ワークロード向け。 |
| **メモリ最適化**         | R, X       | メモリ集約型アプリケーション（インメモリDB、キャッシュ）向け。 |
| **ストレージ最適化**     | I, D, H  | 高速なローカルストレージが必要なデータ集約型ワークロード向け。 |
| **高速コンピューティング** | P, G, F | GPUや専用チップを搭載し、機械学習やHPC向け。 |
| **高メモリ**           | U           | 超大容量メモリを必要とするSAP HANAなどの用途向け。 |
| **z1dシリーズ**       | z1d                | 高クロックのCPUを提供し、金融計算やゲームサーバー向け。 |

## キャパシティ予約

| 項目                       | 説明                                                                                                     |
| -------------------------- | -------------------------------------------------------------------------------------------------------- |
| キャパシティ予約           | ✓ インスタンスタイプが起動可能であるという確保権のこと。<br>✓ 予約キャパシティを確保しておくことで実行時のキャパシティ不足エラーを抑制する。 |
| オンデマンドキャパシティ予約 | ✓ 必要な期間中のみオンデマンドの利用料金でキャパシティが予約できる機能                                             |
| ゾーンリザーブドインスタンス | ✓ 指定したアベイラビリティーゾーン (AZ) 内で1年間または3年間の間のキャパシティを予約する。<br>✓ AZは指定した場所のみ利用可能。 |
| リージョンリザーブドインスタンス | ✓ 指定したリージョン内で1年間または3年間の間のキャパシティを予約する。<br>✓ AZはどこでも利用可能。                 |

### リサーブドインスタンスのコンバーティブルでは変更できるが、スタンダードでは変更できない設定

- インスタンスファミリー
- OS
- テナンシー
- 支払オプション

## EC2のログ取得方法

| 方法                          | 説明                                                                                             | デフォルト | 設定が必要 |
|-------------------------------|----------------------------------------------------------------------------------------------------|----------|------------|
| CloudWatch Logs                | EC2のシステムログやアプリケーションログをCloudWatchに送信して管理・モニタリングできる。             | ×        | 〇          |
| システムログ（/var/log）        | インスタンス内のLinuxディレクトリに保存されるログ。SSH接続で直接確認可能。                         | 〇        | ×          |
| S3へログ出力                   | ログを圧縮してS3バケットにアップロードし、長期保存する方法。                                        | ×        | 〇          |
| CloudTrail                     | EC2 APIコール（起動、停止、変更など）を記録し、アカウント操作履歴を追跡。                          | ×        | 〇          |
| VPC Flow Logs                  | VPC内のネットワークトラフィックをキャプチャしてモニタリングに利用。                                  | ×        | 〇          |
| OSレベルのログ管理ツール        | FluentdやFilebeatを使って外部サービスにログを転送。                                                  | ×        | 〇          |


## その他

### ステートフル vs ステートレスの比較

| 項目             | ステートフル（Stateful）                  | ステートレス（Stateless）                 |
|-----------------|---------------------------------|----------------------------------|
| **状態の管理**  | サーバーが状態（セッション）を保持 | 各リクエストが独立（状態を持たない） |
| **スケーラビリティ** | 低い（同じサーバーに接続が必要） | 高い（どのサーバーでも処理可能） |
| **耐障害性**  | 低い（サーバー障害の影響が大きい） | 高い（サーバー障害に強い） |
| **実装の複雑さ** | 高い（セッション管理が必要） | 低い（セッション管理不要） |
| **代表的な例**  | ログイン管理、ECサイトのカート、ゲームの進行 | REST API、サーバーレス（Lambda）、CDN配信 |

#### どちらを選ぶべきか？

| **要件**                              | **推奨する方式**        |
|--------------------------------------|----------------------|
| セッションや状態を保持する必要がある    | **ステートフル**      |
| 負荷分散を容易にしたい                | **ステートレス**      |
| オートスケーリングを活用したい         | **ステートレス**      |
| EC2が停止しても影響を少なくしたい      | **ステートレス**      |
| データをローカルに保持する必要がある    | **ステートフル**      |
| 可用性・耐障害性を向上させたい         | **ステートレス**      |
| 特定のEC2に依存する設計が許容される    | **ステートフル**      |
| 複数のEC2間で同じ処理を実行したい      | **ステートレス**      |

### 停止と終了の違い

| 項目                        | **停止（Stop）**                                 | **終了（Terminate）**                              |
|-----------------------------|-------------------------------------------------|---------------------------------------------------|
| **インスタンス状態**         | 停止され、再起動可能                             | 完全に終了し、削除される                           |
| **再起動可能性**             | 再起動可能（インスタンスは維持）                | 再起動不可能（新しいインスタンスを起動する必要あり） |
| **課金**                     | インスタンスの使用に関する課金は停止、EBSは課金続行 | インスタンスの課金は停止、EBSも削除すれば課金停止 |
| **IPアドレス**               | 新しいIPアドレスが割り当てられることがある       | 解放され、再割り当てされることがある               |
| **データの保存**             | インスタンスストレージやデータは保持される       | データは削除される（EBSボリュームが保持されていればデータは残る）|

#### どちらを選ぶべきか
- `停止（Stop）` は、インスタンスの設定を保持して再起動したい場合に使用します（メンテナンスなどのために一時的に停止したいとき）。
- `終了（Terminate）` は、不要なインスタンスを完全に削除してリソースを解放したい場合に使用します。

## AMI

AMI（Amazon Machine Image） は、EC2（Elastic Compute Cloud）のインスタンスを起動するためのテンプレートです。
AMIには、OS、アプリケーション、設定など、EC2インスタンスを立ち上げるために必要なすべての情報が含まれています。

### AMIを複数アカウントで共有した場合のソリューション

1. Launch Permission(の設定(共有設定)<br>
AMIを特定のAWSアカウントと共有するために、Launch Permissionを設定できます。この方法では、AMIに対して、他のアカウントがそのAMIを使ってインスタンスを起動できるように許可します。

2. Amazon EC2 Resource Access Manager（RAM）の利用<br>
AWS Resource Access Manager (RAM) を使用することで、AWS Organizations内の複数のアカウントに対してAMIを共有することができます。これにより、複数のアカウント間でリソースを安全に共有できます。

3. S3を使用したAMIバックアップと共有<br>
AMIをバックアップとしてS3バケットに保存し、必要に応じて他のアカウントとS3バケットを共有する方法もあります。この方法では、AMIイメージをS3経由で共有し、異なるアカウントで使用できます。

### 共有設定を変更する方法（ざっくり手順）
1. EC2ダッシュボードにアクセス
2. 左メニュー → 「AMIs（イメージ）」を選択
3. 対象のAMIを選び、「アクション」→「AMIの権限を変更」（Modify Image Permissions）を選択
4. 以下のいずれかを設定：
    - 特定のAWSアカウントIDを追加
    - 「パブリックにする」にチェックを入れる

#### 注意点
- AMI自体だけでなく、`AMIが参照するEBSスナップショットの共有設定`も別途必要です。
- パブリックにすると、誰でも使えてしまうのでセキュリティやライセンス上の確認は大事。
- 暗号化されたEBSスナップショットによってバックアップされたAMIを共有する場合、AMIの共有設定（launchPermission）と、スナップショットの暗号化に使用したKMSキーの使用の許可設定が必要。
  - KMSキーの使用許可設定では、「キーポリシー」で対象のAWSアカウントに許可設定を追加

## Elastic Fabric Adapter (EFA)

- 特定のEC2インスタンスの高性能ネットワーク機能
- HPC（High Performance Computing）用途で使われる高速・低レイテンシ通信用アダプタ
- MPI（Message Passing Interface）アプリケーションなどで、ノード間の通信を高速化
- 通常のVPCネットワークより低レイテンシ・高スループット

## プレイスメントグループ

EC2のプレイスメントグループ（Placement Group）は、複数のEC2インスタンスを物理的にどのように配置するかを制御する仕組みです。
用途に応じてパフォーマンスや可用性を最適化するために使います。

| 種類       | 概要                                                                 | 主な用途                                     |
|------------|----------------------------------------------------------------------|----------------------------------------------|
| Cluster    | 同一のアベイラビリティゾーン内で、インスタンスを物理的に近くに配置 | 低レイテンシ・高スループットなHPCや分散処理 |
| Spread     | インスタンスを異なるハードウェア上に分散配置                        | 高可用性が求められるアプリケーション         |
| Partition  | インスタンスをパーティション単位で物理分離して配置                 | 大規模分散システム（Hadoop、Cassandraなど）  |


### クラスタープレイスメントグループ
- グループ内のEC2インスタンスを単一AZ内の物理的に近い距離に配置
#### 特徴
- 最大ネットワークパフォーマンスを得られる（10Gbps以上の通信帯域）
- 起動失敗の可能性がある（キャパシティが足りないと失敗）
- スケーリングには向かない（台数を増やしづらい）

![image](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/images/placement-group-cluster.png)

### スプレッドプレイスメントグループ
- 異なる物理ハードウェア（ホスト、ラック） に EC2 インスタンスを分散して配置
- インスタンス同士が物理的に独立していることで、障害の影響を最小限に抑えることができる
#### 特徴
- 最大7インスタンス / AZ（1つのグループにつき）
- 高可用性に優れる
- 起動は成功しやすい（分散されるのでリソース競合が少ない）

![image](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/images/placement-group-spread.png)

### パーティションプレイスメントグループ
- インスタンスを「パーティション」と呼ばれるグループに分け、それぞれのパーティションは`独立したハードウェアセット（ラック、ネットワーク、電源）`に配置される。
- 大規模な分散アプリケーションでの耐障害構成に適している。

#### 特徴
- 最大7パーティション（AZにより異なる）
- 各パーティションは論理的に分離され、1つのパーティション障害で他のパーティションには影響なし
- Auto Scaling とも併用可能
![image](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/images/placement-group-partition.png)


## 拡張ネットワーキング（Enhanced Networking）

EC2の拡張ネットワーキング（Enhanced Networking）とは、EC2インスタンスに高スループットかつ低レイテンシなネットワーク性能を提供するための機能です。

標準の仮想ネットワークインターフェイス（ENA以前）よりも、はるかに高性能な通信が可能になります。

| 項目 | 内容 |
|------|------|
| 概要	| 高速なパケット処理で、高スループット・低レイテンシな通信を実現 |
| 対象	| 主にEC2インスタンス（特定のインスタンスタイプ） |
| 主な技術	| ENA（Elastic Network Adapter） または VF（Intel 82599 VF） |
| 効果	| 最大 100 Gbps 超の帯域や、パケットロスの軽減が可能 |
| 利用条件	| 対応インスタンスであり、OSやドライバの対応も必要（Amazon Linux 2などは標準で対応） |

## 購入オプション
### Dedicated Hosts（専有ホスト）

- 他のEC2インスタンスとは分離された専用ハードウェアで利用できる購入オプション。
- 物理的なCPUソケット、コア数、ホストIDを確認できる。
- 利用者があらかじめ購入したソフトウェアライセンス(BYOL)の持ち込みをサポートする

### ハードウェア専有インスタンス

- 他のAWSアカウントとは分離された専用ハードウェアでEC2インスタンスを利用できる購入オプション。
- 物理的なCPUソケット、コア数、ホストIDは確認できない。
- 同AWSアカウントのハードウェア専有インスタンスではないインスタンスと、ハードウェアを共有する可能性がある。
- 利用者があらかじめ購入したソフトウェアライセンス(BYOL)の持ち込みをサポートしない

## スポットフリート
スポットインスタンスのオプションの一つで、必要なインスタンス数を指定することで、指定した数のスポットインスタンスが起動する。<br>
スポットインスタンスが中断されて必要なインスタンス数を下回った場合、自動的にインスタンスを補充してインスタンス数を維持する。
