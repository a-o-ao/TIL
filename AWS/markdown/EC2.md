# Amazon EC2

## AMI

AMI（Amazon Machine Image） は、EC2（Elastic Compute Cloud）のインスタンスを起動するためのテンプレートです。
AMIには、OS、アプリケーション、設定など、EC2インスタンスを立ち上げるために必要なすべての情報が含まれています。

### AMIを複数アカウントで共有した場合のソリューション

1. Launch Permissionの設定<br>
AMIを特定のAWSアカウントと共有するために、Launch Permissionを設定できます。この方法では、AMIに対して、他のアカウントがそのAMIを使ってインスタンスを起動できるように許可します。

2. Amazon EC2 Resource Access Manager（RAM）の利用<br>
AWS Resource Access Manager (RAM) を使用することで、AWS Organizations内の複数のアカウントに対してAMIを共有することができます。これにより、複数のアカウント間でリソースを安全に共有できます。

3. S3を使用したAMIバックアップと共有<br>
AMIをバックアップとしてS3バケットに保存し、必要に応じて他のアカウントとS3バケットを共有する方法もあります。この方法では、AMIイメージをS3経由で共有し、異なるアカウントで使用できます。

## インスタンスタイプ

| カテゴリ                 | インスタンスタイプ           | 特徴 |
|------------------------|---------------------|--------------------------------------------------|
| **汎用（バースト可能）**  | t3, t4g             | コスト効率が良く、CPUクレジットベースで動作する小規模アプリ向け。 |
| **汎用（スタンダード）**  | m5, m6g, m7g       | バランスの取れた性能で、幅広い用途に対応。 |
| **コンピューティング最適化** | c5, c6g, c7g       | 高いCPU性能が求められる計算集約型ワークロード向け。 |
| **メモリ最適化**         | r5, r6g, r7g       | メモリ集約型アプリケーション（インメモリDB、キャッシュ）向け。 |
| **ストレージ最適化**     | i3, i4g, d3, d3en  | 高速なローカルストレージが必要なデータ集約型ワークロード向け。 |
| **アクセラレーテッドコンピューティング** | p4, p5, inf2, trn1 | GPUや専用チップを搭載し、機械学習やHPC向け。 |
| **高メモリ**           | u6i, u7i           | 超大容量メモリを必要とするSAP HANAなどの用途向け。 |
| **z1dシリーズ**       | z1d                | 高クロックのCPUを提供し、金融計算やゲームサーバー向け。 |

## キャパシティ予約

| 項目                       | 説明                                                                                                     |
| -------------------------- | -------------------------------------------------------------------------------------------------------- |
| キャパシティ予約           | ✓ インスタンスタイプが起動可能であるという確保権のこと。<br>✓ 予約キャパシティを確保しておくことで実行時のキャパシティ不足エラーを抑制する。 |
| オンデマンドキャパシティ予約 | ✓ 必要な期間中のみオンデマンドの利用料金でキャパシティが予約できる機能                                             |
| ゾーンリザーブドインスタンス | ✓ 指定したアベイラビリティーゾーン (AZ) 内で1年間または3年間の間のキャパシティを予約する。<br>✓ AZは指定した場所のみ利用可能。 |
| リージョンリザーブドインスタンス | ✓ 指定したリージョン内で1年間または3年間の間のキャパシティを予約する。<br>✓ AZはどこでも利用可能。                 |

### リサーブドインスタンスのコンバーティブルでは変更できるが、スタンダードでは変更できない設定

- インスタンスファミリー
- OS
- テナンシー
- 支払オプション

## EC2のログ取得方法

| 方法                          | 説明                                                                                             | デフォルト | 設定が必要 |
|-------------------------------|----------------------------------------------------------------------------------------------------|----------|------------|
| CloudWatch Logs                | EC2のシステムログやアプリケーションログをCloudWatchに送信して管理・モニタリングできる。             | ×        | 〇          |
| システムログ（/var/log）        | インスタンス内のLinuxディレクトリに保存されるログ。SSH接続で直接確認可能。                         | 〇        | ×          |
| S3へログ出力                   | ログを圧縮してS3バケットにアップロードし、長期保存する方法。                                        | ×        | 〇          |
| CloudTrail                     | EC2 APIコール（起動、停止、変更など）を記録し、アカウント操作履歴を追跡。                          | ×        | 〇          |
| VPC Flow Logs                  | VPC内のネットワークトラフィックをキャプチャしてモニタリングに利用。                                  | ×        | 〇          |
| OSレベルのログ管理ツール        | FluentdやFilebeatを使って外部サービスにログを転送。                                                  | ×        | 〇          |


## その他

### ステートフル vs ステートレスの比較

| 項目             | ステートフル（Stateful）                  | ステートレス（Stateless）                 |
|-----------------|---------------------------------|----------------------------------|
| **状態の管理**  | サーバーが状態（セッション）を保持 | 各リクエストが独立（状態を持たない） |
| **スケーラビリティ** | 低い（同じサーバーに接続が必要） | 高い（どのサーバーでも処理可能） |
| **耐障害性**  | 低い（サーバー障害の影響が大きい） | 高い（サーバー障害に強い） |
| **実装の複雑さ** | 高い（セッション管理が必要） | 低い（セッション管理不要） |
| **代表的な例**  | ログイン管理、ECサイトのカート、ゲームの進行 | REST API、サーバーレス（Lambda）、CDN配信 |

#### どちらを選ぶべきか？

| **要件**                              | **推奨する方式**        |
|--------------------------------------|----------------------|
| セッションや状態を保持する必要がある    | **ステートフル**      |
| 負荷分散を容易にしたい                | **ステートレス**      |
| オートスケーリングを活用したい         | **ステートレス**      |
| EC2が停止しても影響を少なくしたい      | **ステートレス**      |
| データをローカルに保持する必要がある    | **ステートフル**      |
| 可用性・耐障害性を向上させたい         | **ステートレス**      |
| 特定のEC2に依存する設計が許容される    | **ステートフル**      |
| 複数のEC2間で同じ処理を実行したい      | **ステートレス**      |

### 停止と終了の違い

| 項目                        | **停止（Stop）**                                 | **終了（Terminate）**                              |
|-----------------------------|-------------------------------------------------|---------------------------------------------------|
| **インスタンス状態**         | 停止され、再起動可能                             | 完全に終了し、削除される                           |
| **再起動可能性**             | 再起動可能（インスタンスは維持）                | 再起動不可能（新しいインスタンスを起動する必要あり） |
| **課金**                     | インスタンスの使用に関する課金は停止、EBSは課金続行 | インスタンスの課金は停止、EBSも削除すれば課金停止 |
| **IPアドレス**               | 新しいIPアドレスが割り当てられることがある       | 解放され、再割り当てされることがある               |
| **データの保存**             | インスタンスストレージやデータは保持される       | データは削除される（EBSボリュームが保持されていればデータは残る）|

#### どちらを選ぶべきか
- `停止（Stop）` は、インスタンスの設定を保持して再起動したい場合に使用します（メンテナンスなどのために一時的に停止したいとき）。
- `終了（Terminate）` は、不要なインスタンスを完全に削除してリソースを解放したい場合に使用します。
