# Amazon API Gateway

## API Gateway の権限
Amazon API Gatewayでは、作成したAPI を呼び出したり、API キャッシュを更新したりするために、IAM アクションを行うためのアクセス許可を API 発信者に付与する必要があります。API の呼び出しや API キャッシュの更新を API 発信者に許可するには、 IAM ポリシーを作成して、ユーザー、グループ、またはロールにそのポリシーをアタッチして、権限を付与します。

## 機能
### ステージ変数
API Gatewayのステージ変数は、APIの異なるステージ（例えば、開発、テスト、本番）ごとに設定できる動的なキーと値のペアで、環境に応じた設定を簡単に管理できます。

### マッピングテンプレート
API Gatewayのマッピングテンプレートは、リクエストやレスポンスのデータを、API Gatewayとバックエンドサービスとの間で変換するためのテンプレートです。JSONやXMLデータを、特定の形式に変換したり、必要なデータを抽出したりするために使用されます。主に、入力（リクエスト）や出力（レスポンス）のデータを処理する際に役立ちます。

例えば、リクエストのパラメータをバックエンドで使用できる形式に変換したり、レスポンスのフォーマットを変更したりするために利用されます。

### APIエンドポイントタイプ
APIエンドポイントタイプは、API Gatewayで作成するAPIの公開方法に関する設定で、APIがどのようにアクセスされるかを決定します。主に以下の3種類があります：

1. Regional:
    - 一般的に、APIが特定のリージョン内で利用される場合に使用します。
    - このタイプは、低レイテンシと高可用性を提供します。
2. Edge-Optimized:
    - APIをグローバルに提供する場合に使用します。Amazon CloudFrontを使って、APIを世界中のエッジロケーションに最適化して配信します。
    - ユーザーがどこからアクセスしても、最も近いエッジロケーションからAPIレスポンスを得られるため、低レイテンシを実現できます。
3. Private:
    - VPC内からのみアクセス可能なAPIエンドポイントです。外部インターネットからのアクセスを制限し、セキュリティを強化するために使用されます。
    - VPC内のリソースとのみ通信が可能です。

これらのタイプは、APIの使用ケースに応じて選択します。

### キャッシュ
API Gatewayのキャッシュは、APIレスポンスを一時的に保存する機能で、同じリクエストが繰り返される場合に、バックエンドサービスに再度リクエストを送ることなく、キャッシュからレスポンスを返すことで、パフォーマンスを向上させ、バックエンドの負荷を軽減します。

#### 主な特徴：
- パフォーマンス向上: 同じリクエストに対するレスポンスをキャッシュすることで、レスポンス時間を短縮し、ユーザー体験を向上させます。

- コスト削減: キャッシュを利用することで、バックエンドシステムへのリクエスト数を減らし、API呼び出しのコストを削減します。

- キャッシュの有効期限: キャッシュには有効期限を設定でき、指定した時間が経過すると再度バックエンドにリクエストが送信されます。

キャッシュは、特に頻繁にリクエストされるデータを提供するAPIや、レスポンスが変更されにくいリソースに有効です。

## Lambda プロキシ統合

API Gatewayからのリクエストを“まるごと”Lambda関数に渡し、レスポンスもLambdaがすべて返す方式。

#### API Gateway → Lambda（リクエスト）

```json
{
  "resource": "/users/{id}",
  "path": "/users/123",
  "httpMethod": "GET",
  "headers": {
    "Content-Type": "application/json"
  },
  "queryStringParameters": {
    "verbose": "true"
  },
  "pathParameters": {
    "id": "123"
  },
  "body": null,
  "isBase64Encoded": false
}
```

#### Lambda → API Gateway（レスポンス）

```json
{
  "statusCode": 200,
  "headers": {
    "Content-Type": "application/json"
  },
  "body": "{\"id\": \"123\", \"name\": \"Taro\"}"
}
```

## Lambda 非プロキシ統合（カスタム統合）

API Gatewayがリクエストやレスポンスを事前・事後に加工して、Lambdaと連携する方法。<br>
API Gatewayが“仲介役”になり、リクエストやレスポンスをマッピングテンプレートで変換できる統合方法。

#### API Gateway → Lambda（リクエスト）

```velocity
{
  "userId": "$input.params('id')",
  "verbose": "$input.params('verbose')"
}
```

→Lambda はこのようなシンプルな JSON を受け取る：
```json
{
  "userId": "123",
  "verbose": "true"
}
```

#### レスポンスマッピングテンプレート（Lambda → API Gateway）

```velocity
#set($inputRoot = $input.path('$'))
{
  "result": $inputRoot,
  "status": "OK"
}
```

→クライアントにはこう返る：
```json
{
  "result": {
    "id": "123",
    "name": "Taro"
  },
  "status": "OK"
}
```

### Lambda プロキシ統合 と 非プロキシ統合 の違い

| 比較項目 | Lambda プロキシ統合 | 非プロキシ統合（カスタム統合） |
|-----------|----------------------|----------------------------------|
| リクエスト形式 | APIの内容をすべて1つのJSONでLambdaへ渡す | マッピングテンプレートで加工したリクエストをLambdaへ渡す |
| レスポンス形式 | Lambdaがステータスコード・ヘッダー・ボディを含むJSONを返す | Lambdaの出力をテンプレートでAPI Gatewayが整形 |
| 柔軟性 | Lambdaで全て処理（シンプル） | Gateway側で前後処理が可能（柔軟） |
| マッピングテンプレート | ❌ 不要 | ✅ 必要（Velocity Template Language使用） |
| 開発の自由度 | 高い（コードで自由に処理） | 中程度（テンプレートで制御） |
| 主な用途 | サーバーレスAPI、シンプルな構成 | 外部連携、複雑な前後処理が必要なケース |

## API Gateway の認証・認可方法

| 認証方式                         | 特徴                                                                 | 向いているケース                                |
|----------------------------------|----------------------------------------------------------------------|--------------------------------------------------|
| IAM 認証（SigV4）                | AWSサービス間でセキュアにやり取り。SDKが署名処理をサポート。         | AWS環境からのAPI呼び出し、管理APIなどに最適     |
| Amazon Cognito ユーザープール   | ログイン・ユーザー管理がセット。トークンベースの簡易認証が可能。     | Web/Mobileアプリのユーザー向けAPI                |
| Lambda オーソライザー           | 自由なロジックで認証・認可が可能。トークン検証も自前で。             | 独自ID


###  Lambda オーソライザー（旧カスタムオーソライザー）

Amazon API Gateway で使える カスタム認証・認可の仕組み。リクエストが API に届く前に、Lambda 関数を使って認証や認可を行うことができる。

https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html

API Gateway にリクエストが来たときに、それを処理する前に Lambda 関数を呼び出して、認証・認可の判断をさせる仕組み。

この Lambda 関数が、トークンやヘッダーなどを検査して「このユーザーはアクセス可能か？」を判断し、その結果をもとに API Gateway が後続の処理（例えばバックエンドへのアクセス）を許可するかを決定する。

#### 2種類のLambda オーソライザー

|種類|	概要|	主な用途|
|-----|----|----|
|`TOKENタイプ`|	ヘッダーなどから Bearer トークンを受け取って検証|	OAuth 2.0 のようなトークン認証に使う|
|`REQUESTタイプ`|	リクエストのヘッダー、クエリ文字列、パスパラメータなどを使って認証処理	|柔軟な認証・認可ロジックが必要な場合に便利（IP制限や動的ロールなど）|

### Amazon Cognito ユーザープールをオーソライザーとして使用する

https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-integrate-with-cognito.html

Amazon API Gateway では、Lambda オーソライザーの代わりに Amazon Cognito ユーザープールを使って、API へのアクセス制御を行うことができる。

#### Amazon Cognito ユーザープールを使うと…
- API Gateway が自動的にトークン（JWT）を検証してくれます。
- ユーザーのログイン、トークンの管理、セッションの検証までを Cognito が担当。
- 開発者はトークンの内容を必要に応じてバックエンドで使うだけ。

### Lambda オーソライザーと Cognito の違い

| 項目            | Lambda オーソライザー                      | Cognito ユーザープール                          |
|-----------------|--------------------------------------------|-------------------------------------------------|
| 認証ロジック     | 自前で実装（柔軟）                         | AWS が管理（簡単）                              |
| 柔軟性           | 高い（IP制限や複雑なロジックも対応可）    | 中程度（グループ/ロールによる制御が中心）       |
| JWT検証         | 開発者が Lambda で行う                     | API Gateway が自動で行う                        |
| セキュリティ管理 | 開発者が責任を持つ                         | AWS が提供・管理                                |
| 使いやすさ       | 実装と構成がやや複雑                      | 簡単。設定のみで完了                            |

#### どちらを使うべきか？

| シナリオ                                             | 推奨                                        |
|------------------------------------------------------|---------------------------------------------|
| Cognito を ID プロバイダーとして使っている場合       | ✅ Cognito ユーザープール                   |
| 独自の認証方式や柔軟な条件（IP制限など）が必要な場合 | ✅ Lambda オーソライザー                   |
| シンプルで管理コストを減らしたい                     | ✅ Cognito ユーザープール                   |
| 多様な外部認証サービスと連携する必要がある           | ✅ Lambda オーソライザー（または別のID連携）|

## API GatewayのVPCリンク

- Amazon API Gatewayで作成したAPIはユーザーが管理するVPC外に配置される
- 作成したAPIからプライベートサブネット内のAWSリソースへ直接アクセスすることはできない

![image](https://ping-t-resouces.com/uploads/question_image/file/25572/k64028.jpg?t=1694668316)

- VPCリンクを作成しNLB等を指定することでEC2などのAWSリソースにアクセスできる

![image](https://ping-t-resouces.com/uploads/question_image/file/25573/kk64028.jpg?t=1694668319)

## Canaryリリース

- まず既存の本番ステージに新しいAPIバージョンをデプロイし、一部のトラフィックを新しいバージョンに向ける
- 例えば初めは20%のトラフィックを新バージョンに割り当て、新バージョンが安定して動作することが確認されたら、トラフィックの割合を徐々に増やしていき、最終的には全トラフィックを新バージョンに移行する手法
