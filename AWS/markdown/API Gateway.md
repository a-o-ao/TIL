# Amazon API Gateway

## API Gateway の権限
Amazon API Gatewayでは、作成したAPI を呼び出したり、API キャッシュを更新したりするために、IAM アクションを行うためのアクセス許可を API 発信者に付与する必要があります。API の呼び出しや API キャッシュの更新を API 発信者に許可するには、 IAM ポリシーを作成して、ユーザー、グループ、またはロールにそのポリシーをアタッチして、権限を付与します。

## 機能
### ステージ変数
API Gatewayのステージ変数は、APIの異なるステージ（例えば、開発、テスト、本番）ごとに設定できる動的なキーと値のペアで、環境に応じた設定を簡単に管理できます。

### マッピングテンプレート
API Gatewayのマッピングテンプレートは、リクエストやレスポンスのデータを、API Gatewayとバックエンドサービスとの間で変換するためのテンプレートです。JSONやXMLデータを、特定の形式に変換したり、必要なデータを抽出したりするために使用されます。主に、入力（リクエスト）や出力（レスポンス）のデータを処理する際に役立ちます。

例えば、リクエストのパラメータをバックエンドで使用できる形式に変換したり、レスポンスのフォーマットを変更したりするために利用されます。

### APIエンドポイントタイプ
APIエンドポイントタイプは、API Gatewayで作成するAPIの公開方法に関する設定で、APIがどのようにアクセスされるかを決定します。主に以下の3種類があります：

1. Regional:
    - 一般的に、APIが特定のリージョン内で利用される場合に使用します。
    - このタイプは、低レイテンシと高可用性を提供します。
2. Edge-Optimized:
    - APIをグローバルに提供する場合に使用します。Amazon CloudFrontを使って、APIを世界中のエッジロケーションに最適化して配信します。
    - ユーザーがどこからアクセスしても、最も近いエッジロケーションからAPIレスポンスを得られるため、低レイテンシを実現できます。
3. Private:
    - VPC内からのみアクセス可能なAPIエンドポイントです。外部インターネットからのアクセスを制限し、セキュリティを強化するために使用されます。
    - VPC内のリソースとのみ通信が可能です。

これらのタイプは、APIの使用ケースに応じて選択します。

### キャッシュ
API Gatewayのキャッシュは、APIレスポンスを一時的に保存する機能で、同じリクエストが繰り返される場合に、バックエンドサービスに再度リクエストを送ることなく、キャッシュからレスポンスを返すことで、パフォーマンスを向上させ、バックエンドの負荷を軽減します。

#### 主な特徴：
- パフォーマンス向上: 同じリクエストに対するレスポンスをキャッシュすることで、レスポンス時間を短縮し、ユーザー体験を向上させます。

- コスト削減: キャッシュを利用することで、バックエンドシステムへのリクエスト数を減らし、API呼び出しのコストを削減します。

- キャッシュの有効期限: キャッシュには有効期限を設定でき、指定した時間が経過すると再度バックエンドにリクエストが送信されます。

キャッシュは、特に頻繁にリクエストされるデータを提供するAPIや、レスポンスが変更されにくいリソースに有効です。

## Lambda プロキシ統合

API Gatewayからのリクエストを“まるごと”Lambda関数に渡し、レスポンスもLambdaがすべて返す方式。

#### API Gateway → Lambda（リクエスト）

```json
{
  "resource": "/users/{id}",
  "path": "/users/123",
  "httpMethod": "GET",
  "headers": {
    "Content-Type": "application/json"
  },
  "queryStringParameters": {
    "verbose": "true"
  },
  "pathParameters": {
    "id": "123"
  },
  "body": null,
  "isBase64Encoded": false
}
```

#### Lambda → API Gateway（レスポンス）

```json
{
  "statusCode": 200,
  "headers": {
    "Content-Type": "application/json"
  },
  "body": "{\"id\": \"123\", \"name\": \"Taro\"}"
}
```

## Lambda 非プロキシ統合（カスタム統合）

API Gatewayがリクエストやレスポンスを事前・事後に加工して、Lambdaと連携する方法。<br>
API Gatewayが“仲介役”になり、リクエストやレスポンスをマッピングテンプレートで変換できる統合方法。

#### API Gateway → Lambda（リクエスト）

```velocity
{
  "userId": "$input.params('id')",
  "verbose": "$input.params('verbose')"
}
```

→Lambda はこのようなシンプルな JSON を受け取る：
```json
{
  "userId": "123",
  "verbose": "true"
}
```

#### レスポンスマッピングテンプレート（Lambda → API Gateway）

```velocity
#set($inputRoot = $input.path('$'))
{
  "result": $inputRoot,
  "status": "OK"
}
```

→クライアントにはこう返る：
```json
{
  "result": {
    "id": "123",
    "name": "Taro"
  },
  "status": "OK"
}
```

### Lambda プロキシ統合 と 非プロキシ統合 の違い

| 比較項目 | Lambda プロキシ統合 | 非プロキシ統合（カスタム統合） |
|-----------|----------------------|----------------------------------|
| リクエスト形式 | APIの内容をすべて1つのJSONでLambdaへ渡す | マッピングテンプレートで加工したリクエストをLambdaへ渡す |
| レスポンス形式 | Lambdaがステータスコード・ヘッダー・ボディを含むJSONを返す | Lambdaの出力をテンプレートでAPI Gatewayが整形 |
| 柔軟性 | Lambdaで全て処理（シンプル） | Gateway側で前後処理が可能（柔軟） |
| マッピングテンプレート | ❌ 不要 | ✅ 必要（Velocity Template Language使用） |
| 開発の自由度 | 高い（コードで自由に処理） | 中程度（テンプレートで制御） |
| 主な用途 | サーバーレスAPI、シンプルな構成 | 外部連携、複雑な前後処理が必要なケース |

