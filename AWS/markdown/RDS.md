# Amazon RDS

https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/Welcome.html

### 特徴

- Amazon RDS データベースやAmazon Auroraデータベースクラスタに対して「削除保護」機能を有効にすると、設定されたデータベースは削除ができなくなる
- 手動スナップショットを他のAWSアカウントと共有できる
  - 自動バックアップのスナップショットは他アカウントとの共有はできない
  - スナップショットが暗号化されている場合は、KMSキーのキーポリシーの設定で共有先のアカウントへKMS暗号化キーの使用を許可する必要がある。
- 自動バックアップの保持期間は最大で35日。35日を超えてスナップショットを保持したい場合は以下の方法がある。
  - AWS Backupでバックアッププランを作成する
  - 手動でスナップショットを取得する（手動で取得したスナップショットには保持期間の上限がありません）
- データベースの移行機能を使って移行できる
  - スナップショットを用いてデータベースの復元
  - 異なるDBエンジンへ移行

## 読み取りパフォーマンスの向上

- リードレプリカを利用して読み取り専用の負荷を分散
- 読み取り処理が一部のクエリに集中している場合はキャッシュを利用

※リードレプリカは非同期的にレプリケートされる個別のデータベースインスタンスであるため、 レプリケーションデータが遅れることがあり、最新のトランザクションのいくつかが表示できない可能性があります。これをレプリケーションラグといいます。

## ストレージタイプ

通常は gp3 がコストとパフォーマンスのバランスが良く、高性能が必要なら io2 を選ぶのが一般的です。

| ストレージタイプ                         | 特徴 |
|--------------------------------|------------------------------------------------------------------|
| **汎用SSD（gp2, gp3）**         | コストパフォーマンスが良く、標準的なワークロード向け。gp3はIOPSとスループットを柔軟に設定可能。 |
| **プロビジョンドIOPS SSD（io1, io2）** | 高いIOPSを必要とするアプリ向け。データベースや高負荷ワークロードに適している。 |
| **マグネティック（標準）**        | 旧世代のストレージ。低コストだがパフォーマンスが低いため、推奨されない。 |

## インスタンスタイプ

| カテゴリ           | インスタンスタイプ | 特徴 |
|------------------|-----------------|--------------------------------------------------|
| **汎用（バースト可能）** | db.t3, db.t4g     | コスト効率が良く、小規模なDBや開発環境向け。 |
| **汎用（スタンダード）** | db.m5, db.m6g     | バランスの取れた性能で、中規模ワークロード向け。 |
| **メモリ最適化**     | db.r5, db.r6g     | メモリ集約型ワークロード（DB、分析）向け。 |
| **X1/X2シリーズ**   | db.x2idn, db.x2iedn | 超大容量メモリが必要なDB向け（SAP HANAなど）。 |
| **ストレージ最適化**   | db.i3, db.i4g     | 高速なローカルストレージが必要なDB向け。 |

### EC2とRDSのインスタンスタイプの違い
- RDSでは`「db.」プレフィックス`が付く（例: db.m5.large）。
- 一部のEC2インスタンス（c5などCPU最適化型）は、RDSではサポートされていない。
- RDSでは自動管理機能（バックアップ・フェイルオーバー）が組み込まれているため、EC2とは異なる最適化がされている。

RDS用のインスタンスタイプを選ぶ際は、ワークロードに応じて db.m（汎用）や db.r（メモリ最適化）を選択するのが一般的です。

## CloudWatchとの連携

| 機能名               | 説明                                                                                                           |
|---------------------|----------------------------------------------------------------------------------------------------------------|
| CloudWatch メトリクス | Amazon RDSのアクティブな各データベースのメトリクスを5分間隔で取得して、ダッシュボードに表示する。               |
| 拡張モニタリング       | 送信間隔を秒単位でメトリクスが取得され、ほぼリアルタイムでのモニタリングが可能となる。<br>モニタリングコストが有料になる。 |
| CloudWatchアラーム    | 特定の期間にわたって単一のAmazon RDSメトリクスを監視し、指定したしきい値に関連するメトリクス値に基づいて1つ以上のアクションを実行できる。 |
| CloudWatch Logs      | CloudWatch Logsのデータベースログファイルの監視、保存、およびアクセスが可能になる。                               |
| CloudWatchイベント    | CloudWatchイベントでは、イベントパターンを使用して受信イベントをフィルタリングし、ターゲットをトリガーするルールを作成することができる。 |

## フェールオーバーの流れ

1. プライマリインスタンスで障害が発生
2. スタンバイインスタンスが昇格してプライマリとして機能を引き継ぐ
3. RDS内部でCNAMEレコードをスタンバイインスタンスに更新
4. クライアントが接続している固定エンドポイントが、新しいプライマリを指すようになる

## RDSプロキシ

RDS Proxy は、AWSのマネージドサービスで、Amazon RDS（Relational Database Service）とデータベースクライアント間の接続を管理するためのプロキシ（仲介サービス）です。これにより、データベース接続の効率化、スケーラビリティの向上、可用性の改善を実現します。

RDS ProxyはLambdaだけでなく、EC2、ECS、EKS、Elastic Beanstalk、Fargateなど、さまざまなAWSリソースと連携して、データベース接続の効率化や可用性の向上を図ることができます。

| 特徴                          | **直接接続**                              | **RDS Proxyを使った接続**                           |
|-----------------------------|------------------------------------------|---------------------------------------------------|
| **接続管理**                   | 各アプリケーションが直接データベースに接続  | RDS Proxyが接続をプールして管理                    |
| **接続プーリング**              | なし                                      | あり（接続プールにより効率化）                    |
| **スケーラビリティ**             | 接続数が増えるとデータベースの負荷が増大     | 接続プーリングでデータベース負荷を軽減、スケーラブル |
| **可用性**                      | 障害時、アプリケーションが再接続しなければならない | 自動フェイルオーバーにより、接続の中断を最小化     |
| **認証情報の管理**              | アプリケーションで認証情報を管理            | IAM認証やAWS Secrets Managerとの統合でセキュアに管理 |
| **接続の効率化**                 | 毎回接続を開く必要があり、オーバーヘッドが大きい | 接続の確立/解放を効率化、オーバーヘッドを軽減     |
| **データベースへの負荷**         | 多数の接続要求でデータベースの負荷が高まる    | 接続数を最適化し、データベースの負荷を軽減         |
| **コスト**                       | 接続管理に伴うリソース消費が多い             | 接続プールと効率化によりコスト削減可能             |
| **セキュリティ**                 | アプリケーションに依存した認証情報管理       | IAM、Secrets Managerによるセキュアな認証管理       |
| **管理の簡便さ**                 | アプリケーションで接続管理を行う必要あり     | RDS Proxyが接続管理を一元化、運用が簡単             |

![image](https://ping-t-resouces.com/uploads/question_image/file/26434/k65579.jpg?t=1743311424)

## パラメータグループ、オプショングループで設定可能な項目

タイムゾーンや最大接続数、監査ログなど、データベースに関する設定

## マルチAZ DBクラスター

- マルチAZ構成の新しい高可用性オプション
- 従来のマルチAZ構成とは異なり、3つのアベイラビリティゾーンにまたがって配置される
- 2つのスタンバイインスタンスがリードレプリカとしても機能し、読み取りアクセスが可能
  - 従来のマルチAZ構成ではスタンバイインスタンスにアクセスできない
- フェイルオーバー時には通常35秒未満で切り替わる

![image](https://ping-t-resouces.com/uploads/question_image/file/26617/k65781.jpg?t=1719983421)

### マルチAZ構成

- プライマリDBインスタンスとスタンバイDBインスタンスを2つの異なるAZに1つずつ配置することによって可用性を向上

![image](https://ping-t-resouces.com/uploads/question_image/file/22842/kkk58350.jpg?t=1661918016)

## シャーディング

水平パーティション分割、リレーショナルデータベースの一般的なスケールアウトアプローチ。<br>
データを複数のDBに振り分けることでアクセスを分散させる。<br>
RDSにシャーディング機能があるわけではなく、アプリケーションやミドルウェア側で実装する必要がある。
