# Amazon Kinesis

## Amazon Kinesis Data Streams

https://docs.aws.amazon.com/ja_jp/streams/latest/dev/introduction.html

リアルタイムで大量のストリーミングデータを収集・処理できるサービス。

Amazon Kinesis Data Streamsは、Lambda、S3、Redshift、Elasticsearch、DynamoDBなどと連携することで、リアルタイムデータの処理、分析、保存、監視を効果的に実行できます。

### シャーディング

Amazon Kinesis Data Streamsのシャーディング（Sharding）とは、データストリームを複数の分割単位（シャード）に分けて処理する仕組みです。
各シャードは順序保証されたデータレコードのシーケンスを持ち、並列処理を実現します。

Kinesisの1つのシャードは、1MB /秒のデータ入力と2MB /秒のデータ出力の容量を提供しています。 1つのシャードは、1秒あたり最大1000のPUTレコードをサポートしています。ストリームの総容量はシャード容量の合計です。複数のコンシューマーアプリケーションの合計読み取り数がシャードの制限を超えている場合は、Kinesisデータストリーム内のシャードの数を増やす必要があります。逆にシャードあたりに処理量が少ない場合や、シャード数が余分であるため、減らす必要があります。

- シャードの分割では、1 つのシャードを 2 つシャードに分けます。分割によりストリーム内のシャードの数が増えるため、ストリームのデータ容量は増えます。一方で、Amazon Kinesis Data Streamsはシャード単位で請求されるため、分割によりストリームのコストが増えます。

- シャードの結合では、2 つシャードを 1 つのシャードに組み合わせます。結合によりストリーム内のシャードの数が減るため、ストリームのデータ容量 とコストは減ります。

| シャードタイプ     | 特徴                                          | 原因                                                     | 影響                                            | 対策                                                                                       |
|-----------------|----------------------------------------------|----------------------------------------------------------|-------------------------------------------------|---------------------------------------------------------------------------------------------|
| ホットシャード    | 特定のシャードにデータが集中し、負荷が高い状態 | - パーティションキーの偏り<br>- 同じキーを多用するデータソース | - 書き込みスロットリングが発生<br>- データ遅延や取りこぼし | - パーティションキーを分散するよう設計<br>- シャード数を増加して負荷を分散                   |
| コールドシャード  | 特定のシャードにほとんどデータが流れない状態    | - パーティションキーが均一に分散されていない<br>- データソース停止 | - リソースの無駄が発生                            | - シャード数を削減してリソース最適化<br>- パーティションキーのバランスを見直す                 |

#### パーティションキー

データをシャード（分割単位）に分配するためのキーです。
データレコードごとに指定され、ハッシュ関数によって特定のシャードにマッピングされます。
例えば、ユーザーIDをパーティションキーとして使うことで、同じユーザーのデータが同一シャードに集まります。

- パーティションキーを使ってデータを特定のシャードに割り当てる。
- 同じパーティションキーを持つデータは順序が保証されるため、順序性が重要なデータに適している。
- パーティションキーが偏るとホットシャードが発生しやすくなる。
