# コンピュータシステム

- [命令実行サイクル](#命令実行サイクル)
- [記憶装置](#記憶装置)
- [仮想記憶](#仮想記憶)

## 命令実行サイクル

### 命令実行サイクルの4つのステップ

```
┌─────────┐
│ 命令フェッチ  │ ← PC参照 → メモリ → IR格納
└─────┬───┘
      ↓
┌─────────┐
│ デコード    │ ← IR解析、アドレス指定方式決定
└─────┬───┘
      ↓
┌─────────┐
│ オペランド読出 │ ← レジスタ / メモリ / 即値
└─────┬───┘
      ↓
┌─────────┐
│ 命令実行    │ → ALU / 制御回路
└─────────┘
```

### 主なアドレス指定方式

| アドレス指定方式 | 特徴 |
| --- | --- |
| 即値 | 値が命令内に直接含まれる |
| レジスタ | 汎用レジスタ内のデータを使う |
| 直接 | 命令内にメモリアドレスが含まれる |
| 間接 | 指定先に格納されたアドレスを参照する |
| インデックス | 基本アドレスにオフセットを加えて実効アドレスを求める |
| 基底レジスタ | 基底レジスタの値にオフセットを加えて実効アドレスを求める |
| 相対 | プログラムカウンタにオフセットを加えて実効アドレスを求める |


## 記憶装置

| 種類  | 揮発性 | 主な用途         | 説明 |
|-------|--------|----------------|------|
| DRAM  | 揮発性 | メインメモリ（RAM） | コンデンサに蓄えた電荷の有無で情報を記憶する。安価だが定期的にリフレッシュが必要。アドレス単位(バイト単位)で読み書きする |
| SRAM  | 揮発性 | キャッシュメモリ    | フリップフロップ回路でデータを保持。高速だが高価で容量は少なめ。 |
| ROM   | 不揮発性 | ファームウェアなど  | 読み出し専用。電源を切っても内容は消えない。種類によって書き換え可能なものもある。 |
| SSD   | 不揮発性 | データ保存（補助記憶） | フラッシュメモリを使ったストレージ。HDDより高速で耐衝撃性がある。 |

### キャッシュメモリと主記憶がある場合の平均アクセス時間

```
AMAT = h × Tc + (1 − h) × Tm
```

- h：キャッシュヒット率
- 𝑇𝑐：キャッシュヒット時のアクセス時間
- Tm：キャッシュミス時にかかるアクセス時間（＝主記憶アクセス時間）

### ライトスルー方式とライトバック方式

| 方式 | 動作 | 利点 | 欠点 | 主な用途 |
| --- | --- | --- | --- | --- |
| ライトスルー (Write Through) | キャッシュに書き込むと同時に主記憶にも書き込む | 主記憶が常に最新で整合性管理が簡単 | 主記憶アクセスが多く遅くなる | 小規模キャッシュや整合性重視のシステム |
| ライトバック (Write Back) | キャッシュにだけ書き込み、追い出し時に主記憶へ反映（ダーティビットで管理） | 主記憶アクセスが減り高速 | 主記憶とキャッシュの内容が一時的に不一致になる、制御が複雑 | 高速化重視のCPUキャッシュ |


### ROM
- マスクROM (書き込み不可)
- EEPROM (電気で書き換え、一括またはブロック単位で消去可能)

## 仮想記憶

| 項目       | スワッピング (Swapping)                     | ページング (Paging)                       |
|------------|--------------------------------------------|-----------------------------------------|
| 単位       | プロセス全体または大きなブロック単位       | ページ（固定サイズの小さなブロック単位） |
| データの移動先 | 主記憶 ⇄ 補助記憶（ディスク）                | 主記憶 ⇄ 補助記憶（ディスク）            |
| 目的       | メモリ不足時にプロセスを丸ごと退避させる    | 必要なページだけをメモリに読み込む       |
| メリット   | 実装が比較的簡単                            | メモリ効率が良く、プロセスの一部だけを扱える |
| デメリット | プロセス全体を移動するためオーバーヘッド大 | ページフォールト発生時に処理が遅くなる場合がある |
| 主な用途   | マルチプログラム環境でメモリ管理           | 現代OSの標準的仮想記憶管理方式           |

- スワッピング：プロセス丸ごと移動 → 大きな単位で扱う
- ページング：必要なページだけ移動 → メモリ効率を最適化

### ページ置換アルゴリズム

ページ置換アルゴリズムは、ページング方式の仮想記憶でメモリ不足が発生したとき、
「どのページを追い出すか（置き換えるか）」を決める仕組み

| アルゴリズム | 特徴 | メリット | デメリット |
|--------------|------|----------|------------|
| FIFO (First-In First-Out) | 最も古くメモリに入ったページを置換 | 実装が簡単 | 古いがまだ使うページを追い出す可能性がある |
| LRU (Least Recently Used) | 最も長い間使われていないページを置換 | 実際の使用パターンに近い性能を出せる | 使用履歴の管理が必要でオーバーヘッド大 |
| LFU (Least Frequently Used) | 使用回数が最も少ないページを置換 | 頻繁に使うページを残せる | 一時的な集中アクセスに弱い |
| Optimal (OPT) | 将来最も長く使われないページを置換 | 理論的に最もページフォールトが少ない | 実際には未来のアクセスは分からないのでシミュレーション用 |
| Clock (Second Chance) | FIFOを改良し、参照ビットで「使用中」かを判定 | 実装が比較的簡単でLRUに近い性能 | 完全なLRUほどではない |



